<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Healthy Meal Engine ‚Äì Busy Worker Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Turn your grocery budget into a simple, realistic, healthy weekly meal plan with a consolidated grocery list." />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- jsPDF + html2canvas for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-vqEJq8yY7gHLm9Wgq3wWQ9tY8H2dI9G0nRANi0Y3eW9G0nO1nGfJ2Z4vS6dR0nD4VYt3Gk7c1r5m+P+UnxTug==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNa5lH5d3N4z7o2ZJ3IruuCz8Vqg3+eG1dFfY7qD8y0k7x1VtE7H5fX6V9Z2s+q5fY5lq3z1cZ7Y7Z8u2yLJQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root {
      --bg: #f3f6fa;
      --card-bg: #ffffff;
      --accent: #31c16f;
      --accent-soft: #e4f8ed;
      --accent-strong: #1a9b51;
      --accent-secondary: #4f8cff;
      --border-subtle: #dde5f0;
      --text-main: #1b2938;
      --text-muted: #6b7380;
      --chip-bg: #edf2ff;
      --chip-border: #d6e0ff;
      --danger-soft: #ffe7e5;
      --danger-text: #b92a2a;
      --shadow-soft: 0 18px 40px rgba(11, 25, 56, 0.09);
      --radius-lg: 22px;
      --radius-md: 16px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px 12px 48px;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #e4ffe8 0, #f3f6fa 42%, #f9fbff 100%);
      color: var(--text-main);
    }

    .page {
      max-width: 1040px;
      margin: 0 auto;
    }

    .app-shell {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.4fr);
      gap: 22px;
      align-items: flex-start;
      background: linear-gradient(145deg, #f4fff7 0, #f7fbff 32%, #ffffff 100%);
      padding: 24px;
      border-radius: 32px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(160, 195, 215, 0.3);
    }

    @media (max-width: 880px) {
      body {
        padding: 12px 8px 28px;
      }
      .app-shell {
        grid-template-columns: minmax(0, 1fr);
        padding: 18px 14px 20px;
        border-radius: 24px;
      }
    }

    /* HEADER */
    .hero-card {
      background: radial-gradient(circle at top left, #e5ffe9, #f4fff7);
      border-radius: 28px;
      padding: 18px 18px 16px;
      border: 1px solid rgba(38, 171, 89, 0.16);
      box-shadow: 0 16px 36px rgba(11, 148, 74, 0.1);
      position: relative;
      overflow: hidden;
    }

    .logo-pill {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .logo-circle {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: radial-gradient(circle at 20% 0, #7fffb5, #1aaa48);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
      font-size: 18px;
      box-shadow: 0 8px 20px rgba(24, 146, 71, 0.35);
    }

    .logo-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .logo-text-title {
      font-weight: 700;
      font-size: 18px;
      letter-spacing: 0.01em;
    }

    .logo-text-sub {
      font-size: 12px;
      color: #2f6a3b;
    }

    .value-pills {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 8px;
      margin-bottom: 10px;
    }

    .value-pill {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      background: #ffffff;
      padding: 6px 10px;
      font-size: 11px;
      border: 1px solid rgba(138, 198, 158, 0.5);
      color: #28533b;
      gap: 8px;
    }

    .traffic-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #24c457;
      box-shadow: 0 0 0 6px rgba(54, 182, 95, 0.25);
    }

    .traffic-dot.secondary {
      background: #4f8cff;
      box-shadow: 0 0 0 6px rgba(79, 140, 255, 0.25);
    }

    .hero-body-text {
      font-size: 13px;
      line-height: 1.5;
      color: #305541;
      margin-bottom: 12px;
    }

    .hero-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .hero-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      background: #ffffffbf;
      border: 1px dashed rgba(85, 166, 114, 0.7);
      color: #28533b;
    }

    .hero-badge-emoji {
      font-size: 14px;
    }

    .hero-footer {
      margin-top: 12px;
      font-size: 11px;
      color: #56756a;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .hero-footer span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .hero-footer-chip {
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(180, 218, 195, 0.9);
    }

    /* FORM CARD */

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(188, 203, 226, 0.7);
      padding: 14px 16px 16px;
      box-shadow: 0 12px 26px rgba(15, 38, 70, 0.06);
    }

    .card + .card {
      margin-top: 12px;
    }

    .card-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 10px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .pill-toggle {
      display: inline-flex;
      padding: 3px;
      border-radius: var(--radius-pill);
      background: #edf1fa;
      border: 1px solid rgba(173, 187, 214, 0.9);
      font-size: 11px;
      gap: 2px;
    }

    .pill-toggle button {
      border: none;
      padding: 6px 12px;
      border-radius: 999px;
      background: transparent;
      font: inherit;
      cursor: pointer;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .pill-toggle button.active {
      background: #1ab15a;
      color: #ffffff;
      box-shadow: 0 7px 14px rgba(19, 130, 63, 0.4);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 10px;
      margin-top: 4px;
    }

    .field label {
      display: block;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-main);
      margin-bottom: 4px;
    }

    .field label span.helper {
      font-weight: 400;
      color: var(--text-muted);
    }

    .field input,
    .field select,
    .field textarea {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 8px 12px;
      font: inherit;
      font-size: 12px;
      outline: none;
      background: #f9fbff;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .field textarea {
      border-radius: 14px;
      resize: vertical;
      min-height: 60px;
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color: #4f8cff;
      box-shadow: 0 0 0 1px rgba(79, 140, 255, 0.25);
      background: #ffffff;
    }

    .field-row {
      margin-top: 6px;
    }

    .field-row + .field-row {
      margin-top: 8px;
    }

    .field.inline-2 {
      display: grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap: 8px;
    }

    .hint-row {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .hint-row strong {
      color: #28533b;
    }

    .store-row {
      display: grid;
      grid-template-columns: 1.3fr 1.1fr;
      gap: 8px;
    }

    @media (max-width: 880px) {
      .form-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      .store-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .switch-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .switch {
      position: relative;
      width: 34px;
      height: 18px;
      border-radius: 999px;
      background: #dde5f0;
      cursor: pointer;
      flex-shrink: 0;
    }

    .switch-thumb {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: white;
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.25);
      transition: transform 0.16s ease;
    }

    .switch.on {
      background: #27b45d;
    }

    .switch.on .switch-thumb {
      transform: translateX(16px);
    }

    .primary-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .btn-primary {
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #26c46a, #19aa55);
      color: white;
      font-weight: 600;
      padding: 9px 18px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(26, 151, 82, 0.4);
    }

    .btn-primary span.sparkle {
      font-size: 14px;
    }

    .btn-secondary {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: #f5f7fb;
      color: var(--text-muted);
      font-size: 12px;
      padding: 8px 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .btn-icon {
      width: 18px;
      height: 18px;
      border-radius: 8px;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.18);
    }

    /* RESULTS / SUMMARY */

    #results {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .summary-banner {
      background: var(--accent-soft);
      border-radius: 22px;
      padding: 10px 14px;
      border: 1px solid rgba(91, 204, 132, 0.6);
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      align-items: center;
      justify-content: space-between;
    }

    .summary-main {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      font-size: 13px;
      font-weight: 500;
      color: #134125;
    }

    .summary-tag {
      background: #ffffffbd;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      border: 1px dashed rgba(61, 165, 104, 0.6);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .summary-gap {
      font-size: 12px;
      color: #24583a;
    }

    .summary-gap.over {
      color: var(--danger-text);
    }

    /* Day cards */

    .day-card {
      background: #ffffff;
      border-radius: 22px;
      border: 1px solid rgba(196, 209, 230, 0.9);
      padding: 10px 12px 12px;
      box-shadow: 0 10px 28px rgba(15, 38, 70, 0.06);
    }

    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
      gap: 12px;
    }

    .day-header h3 {
      margin: 0;
      font-size: 13px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .day-cost {
      font-size: 12px;
      color: var(--text-muted);
    }

    .meal-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    @media (max-width: 880px) {
      .meal-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .meal-card {
      background: #f7f9ff;
      border-radius: 18px;
      padding: 8px 10px 9px;
      border: 1px solid rgba(198, 210, 232, 0.9);
    }

    .meal-heading {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      color: #6b7589;
      margin-bottom: 2px;
    }

    .meal-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 6px;
    }

    .chip {
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 10px;
      border: 1px solid var(--chip-border);
      background: var(--chip-bg);
      color: #30406b;
      white-space: nowrap;
    }

    .chip.green {
      background: #e5f9ec;
      border-color: #b0e3c0;
      color: #235331;
    }

    .chip.orange {
      background: #fff2e1;
      border-color: #ffd1a1;
      color: #8b4e08;
    }

    .chip.red {
      background: #ffe8ea;
      border-color: #ffc1c7;
      color: #9c2531;
    }

    .chip.meta {
      background: #eef2ff;
      border-color: #cdd7ff;
      color: #364280;
    }

    .meal-meta {
      display: inline-flex;
      gap: 6px;
      margin-bottom: 6px;
      font-size: 10px;
      color: #5b6686;
    }

    .meal-meta span {
      border-radius: 999px;
      padding: 3px 8px;
      background: #ffffff;
      border: 1px solid rgba(200, 210, 235, 0.9);
    }

    .nutri-line {
      display: inline-flex;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 10px;
      color: #435570;
    }

    .nutri-line span {
      border-radius: 999px;
      padding: 3px 8px;
      background: #eefbf4;
      border: 1px solid rgba(145, 210, 175, 0.9);
    }

    .meal-how {
      font-size: 11px;
      margin-top: 3px;
      color: #394864;
    }

    .meal-how ul {
      padding-left: 18px;
      margin: 4px 0 0;
    }

    .meal-how li {
      margin-bottom: 3px;
    }

    /* Grocery list */

    .grocery-card {
      background: #ffffff;
      border-radius: 22px;
      border: 1px dashed rgba(186, 199, 220, 0.95);
      padding: 10px 12px 12px;
      box-shadow: 0 12px 30px rgba(16, 36, 64, 0.05);
    }

    .grocery-header-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: baseline;
      margin-bottom: 6px;
    }

    .grocery-title {
      font-size: 13px;
      font-weight: 600;
    }

    .grocery-meta-text {
      font-size: 11px;
      color: var(--text-muted);
      text-align: right;
    }

    .grocery-items {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .grocery-item-row {
      border-radius: 14px;
      padding: 6px 8px;
      background: #f8faff;
      border: 1px solid rgba(204, 213, 233, 0.9);
    }

    .grocery-name {
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 2px;
    }

    .grocery-line {
      font-size: 11px;
      color: #53627e;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .grocery-line span.highlight {
      color: #1f5b30;
      font-weight: 500;
    }

    .grocery-store {
      font-size: 11px;
      color: #2f673b;
      margin-top: 2px;
    }

    .footer-note {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .results-footer-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    /* Copy + PDF buttons */
    .btn-ghost {
      border-radius: 999px;
      border: 1px solid rgba(203, 214, 229, 0.9);
      background: #ffffff;
      padding: 7px 12px;
      font-size: 11px;
      color: #44506b;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .btn-ghost .btn-icon {
      background: #f4f7ff;
    }

    .toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%) translateY(40px);
      background: #111827;
      color: #f9fafb;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 11px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.6);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease, transform 0.18s ease;
      z-index: 50;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* PRINT / PDF TUNING */

    @media print {
      body {
        margin: 0;
        padding: 0;
        background: #ffffff !important;
        font-size: 14px;
      }

      .page {
        max-width: none;
        margin: 0;
      }

      .app-shell {
        box-shadow: none;
        border-radius: 0;
        padding: 16px;
        background: #ffffff !important;
      }

      #results {
        width: 100% !important;
        max-width: none !important;
        padding: 0 !important;
      }

      .summary-banner,
      .day-card,
      .grocery-card {
        page-break-inside: avoid;
        break-inside: avoid;
      }

      .primary-actions,
      .results-footer-actions,
      .btn-secondary,
      .btn-primary {
        display: none !important;
      }
    }
  </style>
</head>

<body>
<div class="page">
  <div class="app-shell">
    <!-- LEFT: INPUTS -->
    <div class="left-column">
      <div class="hero-card">
        <div class="logo-pill">
          <div class="logo-circle">H</div>
          <div class="logo-text">
            <div class="logo-text-title">Healthy Meal Engine</div>
            <div class="logo-text-sub">Turn your grocery budget into a simple, realistic plan.</div>
          </div>
        </div>

        <div class="value-pills">
          <div class="value-pill">
            <span class="traffic-dot"></span>
            <span><strong>Primary:</strong> Busy Worker ¬∑ max results, minimal cooking, still healthy</span>
          </div>
          <div class="value-pill">
            <span class="traffic-dot secondary"></span>
            <span><strong>Secondary:</strong> Budget-First ¬∑ stretch every dollar without eating trash</span>
          </div>
        </div>

        <p class="hero-body-text">
          No calorie math, no diet culture ‚Äî just practical meals and a grocery list that match your time, money, and cravings.
        </p>

        <div class="hero-badges">
          <div class="hero-badge">
            <span class="hero-badge-emoji">üçΩÔ∏è</span> 3 meals + snacks covered
          </div>
          <div class="hero-badge">
            <span class="hero-badge-emoji">üßæ</span> Grocery list included
          </div>
          <div class="hero-badge">
            <span class="hero-badge-emoji">üí∏</span> Budget-aware picks
          </div>
        </div>

        <div class="hero-footer">
          <span class="hero-footer-chip">Built for real life, not Pinterest perfection.</span>
        </div>
      </div>

      <div class="card">
        <div class="card-title-row">
          <div>
            <div class="card-title">Build your week</div>
            <div class="card-subtitle">
              Tell the engine how you actually live. We‚Äôll return meals + a grocery list that match your budget and energy.
            </div>
          </div>
          <div class="pill-toggle" id="focusToggle">
            <button type="button" data-mode="busy" class="active">Busy Worker</button>
            <button type="button" data-mode="budget">Budget-First</button>
          </div>
        </div>

        <div class="form-grid">
          <div class="field">
            <label>Who are we feeding & for how long?</label>
            <div class="field inline-2">
              <input id="totalBudget" type="number" min="10" step="1" placeholder="Total budget ($)" />
              <input id="numDays" type="number" min="3" max="7" step="1" placeholder="# days (3-7)" />
            </div>
            <div class="hint-row">
              <strong>Hint:</strong> Start with 5‚Äì7 days and a realistic budget (e.g. $60‚Äì$120).
            </div>
          </div>

          <div class="field">
            <label>Store profile <span class="helper">We‚Äôll nudge prices + brands.</span></label>
            <div class="store-row">
              <select id="storeProfile">
                <option value="generic">Generic store brand (blended)</option>
                <option value="aldi">Aldi / Lidl style (max savings)</option>
                <option value="walmart">Walmart / big-box blend</option>
                <option value="traderjoes">Trader Joe‚Äôs-ish (slightly higher)</option>
              </select>
              <select id="priceMode">
                <option value="simple">Simple price view</option>
                <option value="detailed">Detailed per-item math</option>
              </select>
            </div>
            <div class="hint-row">
              Prices are rough estimates based on discount-grocer style pricing. Your store may vary.
            </div>
          </div>
        </div>

        <div class="field-row">
          <div class="field">
            <label>Eating style <span class="helper">We‚Äôll only show meals that fit.</span></label>
            <select id="eatingStyle">
              <option value="omnivore">Omnivore (no major restrictions)</option>
              <option value="no-pork">No pork</option>
              <option value="pescatarian">Pescatarian (fish + dairy, no meat)</option>
              <option value="vegetarian">Vegetarian (no meat/fish)</option>
            </select>
          </div>
        </div>

        <div class="field-row">
          <div class="field">
            <label>Hard no ingredients <span class="helper">Comma-separated (e.g. ‚Äúpeanut butter, tuna, mushrooms‚Äù).</span></label>
            <input id="hardNoIngredients" type="text" placeholder="List anything you refuse to eat‚Ä¶" />
          </div>
        </div>

        <div class="field-row">
          <div class="field">
            <label>Life constraints (optional)</label>
            <textarea id="lifestyleNotes" placeholder="Short notes like ‚Äúno oven‚Äù, ‚Äúoffice microwave only‚Äù, ‚Äúgym 3x nights‚Äù, ‚Äúneed leftovers for lunch‚Äù"></textarea>
          </div>
        </div>

        <div class="switch-row">
          <div class="switch" id="nutritionToggle">
            <div class="switch-thumb"></div>
          </div>
          <span>Show approximate calories & protein per meal (good enough estimates, not medical-grade tracking).</span>
        </div>

        <div class="primary-actions">
          <button class="btn-primary" id="generateBtn">
            <span class="sparkle">‚ú®</span>
            <span>Generate meal plan</span>
          </button>
          <button class="btn-secondary" id="clearBtn">
            <div class="btn-icon">‚ü≤</div>
            <span>Clear answers</span>
          </button>
        </div>
      </div>
    </div>

    <!-- RIGHT: RESULTS -->
    <div class="right-column" id="resultsColumn">
      <div id="results">
        <!-- Filled by JS -->
      </div>
      <div class="results-footer-actions" id="resultsActions" style="display:none;">
        <button class="btn-ghost" id="copyGroceriesBtn">
          <div class="btn-icon">üìã</div>
          <span>Copy grocery list</span>
        </button>
        <button class="btn-ghost" id="downloadPdfBtn">
          <div class="btn-icon">üìÑ</div>
          <span>Download plan as PDF</span>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  // ------------------------------
  // DATA
  // ------------------------------

  const storeProfiles = {
    generic: { label: "Any grocery / big-box", priceMultiplier: 1.0 },
    aldi: { label: "Discount grocer (Aldi/Lidl/Walmart)", priceMultiplier: 0.9 },
    walmart: { label: "Big-box blend (Walmart/Target)", priceMultiplier: 1.0 },
    traderjoes: { label: "Trader Joe‚Äôs-ish / specialty grocer", priceMultiplier: 1.15 }
  };

  const ingredientCatalog = {
    apples: { basePrice: 3.0, storeHint: "Produce section (any grocery)", band: "$" },
    bananas: { basePrice: 2.5, storeHint: "Produce section (any grocery)", band: "$" },
    babyCarrots: { basePrice: 2.2, storeHint: "Produce section (any grocery)", band: "$" },
    carrots: { basePrice: 2.8, storeHint: "Produce section (any grocery)", band: "$" },
    babyPotatoes: { basePrice: 3.2, storeHint: "Produce section (any grocery)", band: "$" },
    spinach: { basePrice: 2.2, storeHint: "Produce section (any grocery)", band: "$" },
    lemons: { basePrice: 2.8, storeHint: "Produce section (any grocery)", band: "$$" },
    wholeGrainBread: { basePrice: 3.0, storeHint: "Bakery or bread aisle (any grocery)", band: "$" },
    tortillas: { basePrice: 2.5, storeHint: "Bread/tortilla aisle (any grocery)", band: "$" },
    greekYogurt: { basePrice: 5.0, storeHint: "Refrigerated dairy (any grocery)", band: "$" },
    granola: { basePrice: 4.5, storeHint: "Cereal aisle (big-box or grocery)", band: "$$" },
    frozenBerries: { basePrice: 4.0, storeHint: "Freezer aisle (discount grocer or big-box)", band: "$" },
    chiaSeeds: { basePrice: 4.5, storeHint: "Bulk aisle or online (Amazon)", band: "$$" },
    rolledOats: { basePrice: 3.0, storeHint: "Discount grocer or bulk aisle", band: "$" },
    peanutButter: { basePrice: 3.0, storeHint: "Peanut butter/jam aisle", band: "$" },
    cannedTuna: { basePrice: 3.5, storeHint: "Canned goods aisle (any grocery)", band: "$" },
    frozenGrainVeggieBowl: { basePrice: 5.0, storeHint: "Freezer aisle (big-box / grocery)", band: "$$" },
    chickenThighs: { basePrice: 8.0, storeHint: "Discount grocer (Aldi/Lidl/Walmart)", band: "$" },
    seasoningBlend: { basePrice: 2.5, storeHint: "Spice aisle (any grocery)", band: "$$" },
    oliveOil: { basePrice: 6.0, storeHint: "Oils aisle (any grocery store / big-box)", band: "$$" },
    frozenSalmon: { basePrice: 10.0, storeHint: "Freezer / seafood section", band: "$$" },
    rice: { basePrice: 4.0, storeHint: "Rice/grains aisle (any grocery)", band: "$$" },
    frozenGreenBeans: { basePrice: 3.0, storeHint: "Frozen or produce section", band: "$" },
    hummus: { basePrice: 4.0, storeHint: "Refrigerated dips (any grocery)", band: "$" },
    cucumber: { basePrice: 1.8, storeHint: "Produce section (any grocery)", band: "$$" },
    feta: { basePrice: 4.0, storeHint: "Cheese section (any grocery)", band: "$$" },
    proteinBars: { basePrice: 6.5, storeHint: "Snacks or nutrition aisle (big-box/grocery)", band: "$$" },
    proteinPowder: { basePrice: 18.0, storeHint: "Online/big-box (Amazon, Walmart, Target)", band: "$$" },
    oatOrAlmondMilk: { basePrice: 3.5, storeHint: "Dairy alternative section (any grocery)", band: "$$" },
    milkOrWater: { basePrice: 2.5, storeHint: "Any grocery / big-box", band: "$$" },
    electrolytePowder: { basePrice: 5.0, storeHint: "Sports nutrition / pharmacy / online", band: "$$" },
    rotisserieChicken: { basePrice: 7.5, storeHint: "Grocery deli / hot foods", band: "$$" },
    picklesOrCelery: { basePrice: 3.0, storeHint: "Pickle aisle or produce", band: "$$" },
    greenTeaBags: { basePrice: 2.5, storeHint: "Tea/coffee aisle", band: "$" },
    water: { basePrice: 3.0, storeHint: "Any grocery store / big-box", band: "$$" },
    flavorDrops: { basePrice: 4.0, storeHint: "Any grocery store / big-box", band: "$$" }
  };

  // Meals: templates with macro & ingredient references
  const mealTemplates = {
    breakfastOvernightOats: {
      slot: "BREAKFAST",
      name: "Overnight oats with chia & banana",
      tags: ["busy", "budget", "quick"],
      minutes: 5,
      costPerServing: 1.5,
      calories: 380,
      protein: 18,
      ingredients: [
        { key: "rolledOats", uses: 0.2 },
        { key: "chiaSeeds", uses: 0.1 },
        { key: "oatOrAlmondMilk", uses: 0.2 },
        { key: "bananas", uses: 0.25 },
        { key: "cinnamon", uses: 0 } // informational only
      ],
      instructions: [
        "Add oats, chia seeds, and cinnamon to a jar or container.",
        "Pour in enough milk to fully cover the oats and stir.",
        "Refrigerate overnight; add sliced banana in the morning."
      ]
    },
    breakfastYogurtBowl: {
      slot: "BREAKFAST",
      name: "Greek yogurt + berries + granola",
      tags: ["busy", "budget", "high-protein", "quick"],
      minutes: 3,
      costPerServing: 2.4,
      calories: 420,
      protein: 28,
      ingredients: [
        { key: "greekYogurt", uses: 0.2 },
        { key: "frozenBerries", uses: 0.2 },
        { key: "granola", uses: 0.2 }
      ],
      instructions: [
        "Scoop Greek yogurt into a bowl or container.",
        "Top with a handful of frozen berries.",
        "Sprinkle granola on top right before eating so it stays crunchy."
      ]
    },
    lunchHummusWrap: {
      slot: "LUNCH",
      name: "Hummus, veggie & feta wrap",
      tags: ["busy", "quick"],
      minutes: 7,
      costPerServing: 2.5,
      calories: 440,
      protein: 20,
      ingredients: [
        { key: "tortillas", uses: 0.25 },
        { key: "hummus", uses: 0.2 },
        { key: "cucumber", uses: 0.2 },
        { key: "carrots", uses: 0.2 },
        { key: "feta", uses: 0.15 }
      ],
      instructions: [
        "Spread hummus over the tortilla.",
        "Add sliced cucumber, shredded carrots, and a sprinkle of feta.",
        "Roll up tightly and slice in half if desired."
      ]
    },
    lunchTunaToast: {
      slot: "LUNCH",
      name: "Tuna salad on whole grain toast",
      tags: ["budget", "high-protein"],
      minutes: 8,
      costPerServing: 2.0,
      calories: 430,
      protein: 30,
      ingredients: [
        { key: "cannedTuna", uses: 0.33 },
        { key: "wholeGrainBread", uses: 0.25 },
        { key: "picklesOrCelery", uses: 0.1 },
        { key: "greekYogurt", uses: 0.1 }
      ],
      instructions: [
        "Drain canned tuna and add to a bowl.",
        "Mix with Greek yogurt or light mayo and chopped pickles/celery.",
        "Toast bread and spread tuna salad on top."
      ]
    },
    lunchMicrowaveBowl: {
      slot: "LUNCH",
      name: "Microwave-friendly frozen veggie + protein bowl",
      tags: ["busy", "quick"],
      minutes: 6,
      costPerServing: 3.0,
      calories: 480,
      protein: 24,
      ingredients: [
        { key: "frozenGrainVeggieBowl", uses: 0.5 },
        { key: "rotisserieChicken", uses: 0.25 }
      ],
      instructions: [
        "Heat frozen grain & veggie bowl per package directions.",
        "Shred rotisserie chicken and stir into the bowl for extra protein.",
        "Season to taste (salt, pepper, hot sauce)."
      ]
    },
    dinnerSheetPanChicken: {
      slot: "DINNER",
      name: "Sheet pan chicken, potatoes & carrots",
      tags: ["budget", "high-protein"],
      minutes: 15,
      costPerServing: 3.0,
      calories: 520,
      protein: 35,
      ingredients: [
        { key: "chickenThighs", uses: 0.3 },
        { key: "babyPotatoes", uses: 0.25 },
        { key: "carrots", uses: 0.25 },
        { key: "oliveOil", uses: 0.1 },
        { key: "seasoningBlend", uses: 0.05 }
      ],
      instructions: [
        "Preheat oven to ~400¬∞F (200¬∞C) and line a sheet pan.",
        "Toss chicken, chopped potatoes, and carrots with olive oil and seasoning.",
        "Spread on the pan and roast 25‚Äì35 minutes until cooked through and browned."
      ]
    },
    dinnerBakedSalmon: {
      slot: "DINNER",
      name: "Baked salmon, rice & green beans",
      tags: ["high-protein"],
      minutes: 12,
      costPerServing: 4.2,
      calories: 540,
      protein: 38,
      ingredients: [
        { key: "frozenSalmon", uses: 0.33 },
        { key: "rice", uses: 0.25 },
        { key: "frozenGreenBeans", uses: 0.25 },
        { key: "oliveOil", uses: 0.1 },
        { key: "lemons", uses: 0.15 }
      ],
      instructions: [
        "Preheat oven to ~400¬∞F (200¬∞C). Place salmon on a lined tray; drizzle with olive oil, salt, pepper, and lemon.",
        "Bake 12‚Äì18 minutes depending on thickness.",
        "Cook rice and steam or microwave green beans; serve together."
      ]
    },
    snackCarrotsHummus: {
      slot: "SNACKS",
      name: "Carrots & hummus",
      tags: ["busy", "budget", "quick"],
      minutes: 2,
      costPerServing: 0.9,
      calories: 160,
      protein: 5,
      ingredients: [
        { key: "babyCarrots", uses: 0.25 },
        { key: "hummus", uses: 0.2 }
      ],
      instructions: [
        "Portion baby carrots into a container or snack bag.",
        "Serve with a scoop of hummus for dipping."
      ]
    },
    snackProteinBar: {
      slot: "SNACKS",
      name: "Low-sugar protein bar",
      tags: ["busy", "high-protein", "quick"],
      minutes: 1,
      costPerServing: 1.5,
      calories: 220,
      protein: 18,
      ingredients: [
        { key: "proteinBars", uses: 0.25 }
      ],
      instructions: [
        "Keep a few bars in your bag, desk, or car.",
        "Grab one when you need quick protein on the go."
      ]
    },
    snackApplePb: {
      slot: "SNACKS",
      name: "Apple + peanut butter",
      tags: ["budget", "quick"],
      minutes: 2,
      costPerServing: 1.0,
      calories: 210,
      protein: 6,
      ingredients: [
        { key: "apples", uses: 0.2 },
        { key: "peanutButter", uses: 0.15 }
      ],
      instructions: [
        "Slice an apple just before eating.",
        "Serve with a spoonful or two of peanut butter for dipping."
      ]
    },
    snackRotisserieWrap: {
      slot: "SNACKS",
      name: "Rotisserie chicken mini wrap",
      tags: ["busy", "high-protein"],
      minutes: 4,
      costPerServing: 1.7,
      calories: 260,
      protein: 22,
      ingredients: [
        { key: "rotisserieChicken", uses: 0.3 },
        { key: "tortillas", uses: 0.25 },
        { key: "spinach", uses: 0.2 }
      ],
      instructions: [
        "Spread a little hummus on a tortilla (optional).",
        "Add shredded rotisserie chicken and a handful of spinach.",
        "Roll tightly and slice into bite-size pieces."
      ]
    },
    beverageGreenTea: {
      slot: "BEVERAGES",
      name: "Green tea",
      tags: ["budget", "quick"],
      minutes: 3,
      costPerServing: 0.4,
      calories: 0,
      protein: 0,
      ingredients: [
        { key: "greenTeaBags", uses: 0.1 },
        { key: "water", uses: 0.05 }
      ],
      instructions: [
        "Boil water and let it sit 1‚Äì2 minutes to cool slightly.",
        "Steep green tea bag 2‚Äì3 minutes.",
        "Remove bag to avoid bitterness."
      ]
    },
    beverageWaterFlavor: {
      slot: "BEVERAGES",
      name: "Water + flavor drops or lemon",
      tags: ["budget", "quick"],
      minutes: 1,
      costPerServing: 0.1,
      calories: 0,
      protein: 0,
      ingredients: [
        { key: "water", uses: 0.1 },
        { key: "flavorDrops", uses: 0.05 }
      ],
      instructions: [
        "Fill a bottle or large cup with water.",
        "Squeeze in lemon or add a small amount of flavor drops.",
        "Sip throughout the day."
      ]
    },
    beverageProteinSmoothie: {
      slot: "BEVERAGES",
      name: "Protein smoothie (frozen fruit + protein powder)",
      tags: ["busy", "high-protein", "quick"],
      minutes: 4,
      costPerServing: 2.2,
      calories: 320,
      protein: 30,
      ingredients: [
        { key: "frozenBerries", uses: 0.25 },
        { key: "proteinPowder", uses: 0.25 },
        { key: "milkOrWater", uses: 0.25 },
        { key: "spinach", uses: 0.15 }
      ],
      instructions: [
        "Add frozen fruit, protein powder, and liquid (milk or water) to a blender.",
        "Optionally add a handful of spinach.",
        "Blend until smooth; adjust liquid for desired thickness."
      ]
    }
  };

  // Simple week structure using templates
  const baseWeek = [
    {
      label: "Day 1",
      meals: [
        mealTemplates.breakfastOvernightOats,
        mealTemplates.lunchHummusWrap,
        mealTemplates.dinnerSheetPanChicken,
        mealTemplates.snackProteinBar,
        mealTemplates.beverageGreenTea
      ]
    },
    {
      label: "Day 2",
      meals: [
        mealTemplates.breakfastYogurtBowl,
        mealTemplates.lunchTunaToast,
        mealTemplates.dinnerSheetPanChicken,
        mealTemplates.snackApplePb,
        mealTemplates.beverageWaterFlavor
      ]
    },
    {
      label: "Day 3",
      meals: [
        mealTemplates.breakfastOvernightOats,
        mealTemplates.lunchMicrowaveBowl,
        mealTemplates.dinnerBakedSalmon,
        mealTemplates.snackCarrotsHummus,
        mealTemplates.beverageGreenTea
      ]
    },
    {
      label: "Day 4",
      meals: [
        mealTemplates.breakfastYogurtBowl,
        mealTemplates.lunchHummusWrap,
        mealTemplates.dinnerBakedSalmon,
        mealTemplates.snackApplePb,
        mealTemplates.beverageWaterFlavor
      ]
    },
    {
      label: "Day 5",
      meals: [
        mealTemplates.breakfastOvernightOats,
        mealTemplates.lunchTunaToast,
        mealTemplates.dinnerSheetPanChicken,
        mealTemplates.snackRotisserieWrap,
        mealTemplates.beverageGreenTea
      ]
    },
    {
      label: "Day 6",
      meals: [
        mealTemplates.breakfastYogurtBowl,
        mealTemplates.lunchMicrowaveBowl,
        mealTemplates.dinnerBakedSalmon,
        mealTemplates.snackProteinBar,
        mealTemplates.beverageProteinSmoothie
      ]
    },
    {
      label: "Day 7",
      meals: [
        mealTemplates.breakfastOvernightOats,
        mealTemplates.lunchHummusWrap,
        mealTemplates.dinnerSheetPanChicken,
        mealTemplates.snackCarrotsHummus,
        mealTemplates.beverageWaterFlavor
      ]
    }
  ];

  // ------------------------------
  // HELPERS
  // ------------------------------

  function showToast(message) {
    const t = document.getElementById("toast");
    t.textContent = message;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 1800);
  }

  function parseNoList(str) {
    if (!str) return [];
    return str
      .split(",")
      .map(s => s.trim().toLowerCase())
      .filter(Boolean);
  }

  function estimateDailyCost(day, multiplier) {
    const sum = day.meals.reduce((acc, m) => acc + (m.costPerServing || 0), 0);
    return sum * multiplier;
  }

  function allergyHits(meal, noList) {
    if (!noList.length) return false;
    const combinedName = (meal.name || "").toLowerCase();
    return noList.some(word => combinedName.includes(word));
  }

  function formatDollars(value) {
    return "$" + value.toFixed(1).replace(/\.0$/, "");
  }

  function priceRangeFromWeeklyCost(cost) {
    const rounded = Math.max(1, Math.round(cost));
    if (rounded <= 2) {
      return `$1‚Äì$2`;
    } else if (rounded <= 4) {
      return `$${rounded - 1}‚Äì$${rounded + 1}`;
    } else {
      return `~$${rounded}`;
    }
  }

  // ------------------------------
  // RENDER
  // ------------------------------

  function renderPlan(options) {
    const {
      focusMode,
      totalBudget,
      numDays,
      eatingStyle,
      noList,
      storeKey,
      showNutrition,
      priceMode
    } = options;

    const storeProfile = storeProfiles[storeKey] || storeProfiles.generic;
    const multiplier = storeProfile.priceMultiplier;

    const selectedDays = baseWeek.slice(0, numDays);

    // Adjust for focus mode (very light logic)
    const modeFactor = focusMode === "budget" ? 0.9 : 1.0;

    const resultsEl = document.getElementById("results");
    resultsEl.innerHTML = "";

    // Build grocery aggregation
    const groceryMap = {};

    let totalFoodCost = 0;
    selectedDays.forEach(day => {
      const daily = estimateDailyCost(day, multiplier * modeFactor);
      totalFoodCost += daily;
    });

    // Summary banner
    const summary = document.createElement("div");
    summary.className = "summary-banner";

    const summaryMain = document.createElement("div");
    summaryMain.className = "summary-main";
    summaryMain.innerHTML = `
      <span>Total budget: <strong>${formatDollars(totalBudget)}</strong></span>
      <span>Estimated food cost: <strong>${formatDollars(totalFoodCost)}</strong></span>
    `;

    const gap = totalBudget - totalFoodCost;
    const gapEl = document.createElement("div");
    gapEl.className = "summary-gap" + (gap < 0 ? " over" : "");
    gapEl.textContent =
      gap >= 0
        ? `~${formatDollars(Math.abs(gap))} under budget (buffer for tax / price swings)`
        : `~${formatDollars(Math.abs(gap))} over this budget ‚Äî tighten snacks or protein choices`;

    const tag = document.createElement("div");
    tag.className = "summary-tag";
    tag.innerHTML = `Mode: <strong>${focusMode === "busy" ? "Busy Worker" : "Budget-First"}</strong> ¬∑ Store: ${storeProfile.label}`;

    summary.appendChild(summaryMain);
    summary.appendChild(tag);
    summary.appendChild(gapEl);
    resultsEl.appendChild(summary);

    // Days
    selectedDays.forEach((day, idx) => {
      const dayCard = document.createElement("div");
      dayCard.className = "day-card";

      const dailyCost = estimateDailyCost(day, multiplier * modeFactor);

      const header = document.createElement("div");
      header.className = "day-header";
      header.innerHTML = `
        <h3>${day.label}</h3>
        <div class="day-cost">Est. daily cost: ${formatDollars(dailyCost)}</div>
      `;

      const grid = document.createElement("div");
      grid.className = "meal-grid";

      day.meals.forEach(meal => {
        if (allergyHits(meal, noList)) return;

        // Simple eating style filtering: hide salmon + tuna for vegetarian, hide chicken for pescatarian etc.
        const lower = meal.name.toLowerCase();
        if (eatingStyle === "vegetarian" && (lower.includes("chicken") || lower.includes("salmon") || lower.includes("tuna"))) return;
        if (eatingStyle === "pescatarian" && (lower.includes("chicken"))) return;
        if (eatingStyle === "no-pork" && lower.includes("bacon")) return;

        const card = document.createElement("div");
        card.className = "meal-card";

        const tagsHtml = [];
        meal.tags.forEach(tag => {
          if (tag === "busy") tagsHtml.push(`<span class="chip blue chip busy green">busy-friendly</span>`);
          if (tag === "budget") tagsHtml.push(`<span class="chip green">budget pick</span>`);
          if (tag === "high-protein") tagsHtml.push(`<span class="chip orange">high protein</span>`);
          if (tag === "quick") tagsHtml.push(`<span class="chip red">&lt;10 min prep</span>`);
        });

        const metaHtml = `
          <div class="meal-meta">
            <span>${meal.minutes} min</span>
            <span>~${formatDollars(meal.costPerServing)}/serv</span>
          </div>
        `;

        let nutriHtml = "";
        if (showNutrition) {
          nutriHtml = `
            <div class="nutri-line">
              <span>~${meal.calories} kcal</span>
              <span>${meal.protein}g protein</span>
            </div>
          `;
        }

        const instructionsHtml = `
          <div class="meal-how">
            <div><strong>How to make:</strong></div>
            <ul>${meal.instructions.map(step => `<li>${step}</li>`).join("")}</ul>
          </div>
        `;

        card.innerHTML = `
          <div class="meal-heading">${meal.slot}</div>
          <div class="meal-title">${meal.name}</div>
          <div class="chips-row">${tagsHtml.join("")}</div>
          ${metaHtml}
          ${nutriHtml}
          ${instructionsHtml}
        `;

        grid.appendChild(card);

        // Count grocery usage
        meal.ingredients.forEach(item => {
          if (!item.key || !ingredientCatalog[item.key]) return;
          if (!groceryMap[item.key]) {
            groceryMap[item.key] = {
              key: item.key,
              uses: 0,
              basePrice: ingredientCatalog[item.key].basePrice,
              storeHint: ingredientCatalog[item.key].storeHint,
              band: ingredientCatalog[item.key].band
            };
          }
          groceryMap[item.key].uses += item.uses || 0.25;
        });
      });

      dayCard.appendChild(header);
      dayCard.appendChild(grid);
      resultsEl.appendChild(dayCard);
    });

    // Grocery list
    const groceryKeys = Object.keys(groceryMap);
    groceryKeys.sort((a, b) =>
      ingredientCatalog[a].storeHint.localeCompare(ingredientCatalog[b].storeHint)
    );

    const groceryCard = document.createElement("div");
    groceryCard.className = "grocery-card";

    const groceryHeader = document.createElement("div");
    groceryHeader.className = "grocery-header-row";
    groceryHeader.innerHTML = `
      <div class="grocery-title">Consolidated grocery list</div>
      <div class="grocery-meta-text">
        <div>${groceryKeys.length} unique items</div>
        <div>Est. food cost: ${formatDollars(totalFoodCost)}</div>
      </div>
    `;

    const groceryItemsEl = document.createElement("div");
    groceryItemsEl.className = "grocery-items";

    groceryKeys.forEach(key => {
      const g = groceryMap[key];
      const cat = ingredientCatalog[key];
      const weeklyCost = g.basePrice * storeProfile.priceMultiplier * modeFactor;
      const displayRange = priceRangeFromWeeklyCost(weeklyCost);

      const row = document.createElement("div");
      row.className = "grocery-item-row";

      const nameEl = document.createElement("div");
      nameEl.className = "grocery-name";
      const niceName = key
        .replace(/([A-Z])/g, " $1")
        .replace(/^./, c => c.toUpperCase());
      nameEl.textContent = niceName;

      const line = document.createElement("div");
      line.className = "grocery-line";

      if (priceMode === "detailed") {
        line.innerHTML = `
          <span>${g.uses.toFixed(1).replace(/\.0$/, "")}x uses this week</span>
          <span>Approx. weekly cost: <span class="highlight">${formatDollars(weeklyCost)}</span></span>
          <span>${cat.band}</span>
        `;
      } else {
        line.innerHTML = `
          <span>${g.uses.toFixed(1).replace(/\.0$/, "")}x uses this week</span>
          <span>Budget: <span class="highlight">${displayRange}</span></span>
          <span>${cat.band}</span>
        `;
      }

      const storeHint = document.createElement("div");
      storeHint.className = "grocery-store";
      storeHint.textContent = `Best at: ${cat.storeHint}`;

      row.appendChild(nameEl);
      row.appendChild(line);
      row.appendChild(storeHint);
      groceryItemsEl.appendChild(row);
    });

    groceryCard.appendChild(groceryHeader);
    groceryCard.appendChild(groceryItemsEl);
    const footer = document.createElement("div");
    footer.className = "footer-note";
    footer.textContent =
      "Healthy Meal Engine ¬∑ v1.5 ‚Äì Cooking steps, store hints, and nutrition toggle. Prices are rough estimates based on discount-grocer style pricing. Your store may vary.";
    groceryCard.appendChild(footer);

    resultsEl.appendChild(groceryCard);

    // expose for copy button
    resultsEl.dataset.groceryJson = JSON.stringify(
      groceryKeys.map(key => ({
        name: key
          .replace(/([A-Z])/g, " $1")
          .replace(/^./, c => c.toUpperCase()),
        uses: groceryMap[key].uses,
        weeklyCost:
          groceryMap[key].basePrice * storeProfile.priceMultiplier * modeFactor,
        band: ingredientCatalog[key].band,
        storeHint: ingredientCatalog[key].storeHint
      }))
    );
    resultsEl.dataset.totalFoodCost = totalFoodCost.toString();

    document.getElementById("resultsActions").style.display = "flex";
  }

  // ------------------------------
  // EVENT HANDLERS
  // ------------------------------

  const focusToggle = document.getElementById("focusToggle");
  let focusMode = "busy";

  focusToggle.addEventListener("click", (e) => {
    if (e.target.tagName !== "BUTTON") return;
    const mode = e.target.dataset.mode;
    focusMode = mode;
    [...focusToggle.querySelectorAll("button")].forEach(btn =>
      btn.classList.toggle("active", btn.dataset.mode === mode)
    );
  });

  const nutritionToggle = document.getElementById("nutritionToggle");
  let showNutrition = false;

  nutritionToggle.addEventListener("click", () => {
    showNutrition = !showNutrition;
    nutritionToggle.classList.toggle("on", showNutrition);
  });

  document.getElementById("generateBtn").addEventListener("click", () => {
    const budget = Number(document.getElementById("totalBudget").value || "0");
    const days = Number(document.getElementById("numDays").value || "7");
    const eatingStyle = document.getElementById("eatingStyle").value;
    const storeKey = document.getElementById("storeProfile").value;
    const priceMode = document.getElementById("priceMode").value;
    const noList = parseNoList(document.getElementById("hardNoIngredients").value);

    const numDaysClamped = Math.min(7, Math.max(3, isNaN(days) ? 7 : days));
    const totalBudget = budget > 0 ? budget : 80;

    renderPlan({
      focusMode,
      totalBudget,
      numDays: numDaysClamped,
      eatingStyle,
      noList,
      storeKey,
      showNutrition,
      priceMode
    });
  });

  document.getElementById("clearBtn").addEventListener("click", () => {
    document.getElementById("totalBudget").value = "";
    document.getElementById("numDays").value = "";
    document.getElementById("eatingStyle").value = "omnivore";
    document.getElementById("hardNoIngredients").value = "";
    document.getElementById("lifestyleNotes").value = "";
    document.getElementById("storeProfile").value = "generic";
    document.getElementById("priceMode").value = "simple";
    showNutrition = false;
    nutritionToggle.classList.remove("on");
    document.getElementById("results").innerHTML = "";
    document.getElementById("resultsActions").style.display = "none";
  });

  // Copy grocery list ‚Äì cleaner format
  document.getElementById("copyGroceriesBtn").addEventListener("click", async () => {
    const resultsEl = document.getElementById("results");
    const json = resultsEl.dataset.groceryJson;
    if (!json) return;
    const items = JSON.parse(json);
    const totalCost = Number(resultsEl.dataset.totalFoodCost || "0");

    const lines = [];
    lines.push("Grocery list from Healthy Meal Engine");
    lines.push("");
    items.forEach(item => {
      const range = priceRangeFromWeeklyCost(item.weeklyCost);
      lines.push(
        `- ${item.name} ‚Äî ~${item.uses.toFixed(1).replace(/\.0$/, "")} uses this week, budget: ${range} ‚Ä¢ ${item.storeHint}`
      );
    });
    lines.push("");
    lines.push(`Estimated food cost: ${formatDollars(totalCost)} (before tax).`);

    try {
      await navigator.clipboard.writeText(lines.join("\n"));
      showToast("Grocery list copied to clipboard");
    } catch {
      showToast("Could not copy automatically. Select + copy manually.");
    }
  });

  // PDF DOWNLOAD ‚Äì cleaned up layout
  document.getElementById("downloadPdfBtn").addEventListener("click", async () => {
    const resultsPanel = document.getElementById("results");
    if (!resultsPanel || !resultsPanel.children.length) {
      showToast("Generate a plan first.");
      return;
    }

    const originalPaddingTop = resultsPanel.style.paddingTop;
    resultsPanel.style.paddingTop = "0px";

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "pt", "a4");

    await doc.html(resultsPanel, {
      callback: function (doc) {
        doc.save("Healthy-Meal-Plan.pdf");
        resultsPanel.style.paddingTop = originalPaddingTop;
      },
      margin: [24, 24, 32, 24],
      autoPaging: "text",
      html2canvas: {
        scale: 1.1,
        useCORS: true
      }
    });
  });

  // Initial auto-render (example)
  window.addEventListener("load", () => {
    renderPlan({
      focusMode: "busy",
      totalBudget: 100,
      numDays: 5,
      eatingStyle: "omnivore",
      noList: [],
      storeKey: "generic",
      showNutrition: false,
      priceMode: "simple"
    });
  });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Healthy Meal Engine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Turn your grocery budget into a simple, healthy, realistic weekly meal plan." />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- html2pdf (no integrity/crossorigin so it reliably loads everywhere) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root {
      --bg-soft: #e8f8ec;
      --card-bg: #ffffff;
      --accent: #23c06f;
      --accent-soft: #e0f7ec;
      --accent-dark: #0f8b4b;
      --text-main: #0f172a;
      --text-subtle: #6b7280;
      --pill-bg: #f3f4f6;
      --border-subtle: #e5e7eb;
      --danger: #f97373;
      --tag-green: #22c55e33;
      --tag-orange: #f9731633;
      --tag-blue: #3b82f633;
      --tag-red: #ef444433;
      --radius-xl: 28px;
      --radius-lg: 20px;
      --radius-pill: 999px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.14);
      --shadow-light: 0 10px 25px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #f4fff7 0, #e4f7ea 40%, #d9f1e2 100%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    .page {
      width: 100%;
      max-width: 960px;
      padding: 24px 16px 40px;
    }

    @media (min-width: 768px) {
      .page {
        padding: 40px 24px 64px;
      }
    }

    .app-shell {
      background: linear-gradient(145deg, #f7fff9, #e7f5ec);
      border-radius: 40px;
      padding: 24px 18px 32px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    @media (min-width: 768px) {
      .app-shell {
        padding: 32px 28px 40px;
      }
    }

    /* HEADER */

    .header-card {
      background: radial-gradient(circle at top left, #c3f2d0, #f7fff9 70%);
      border-radius: var(--radius-xl);
      padding: 18px 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 20px;
    }

    @media (min-width: 768px) {
      .header-card {
        padding: 22px 22px 22px;
      }
    }

    .header-top {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .app-avatar {
      width: 56px;
      height: 56px;
      border-radius: 18px;
      background: radial-gradient(circle at 30% 20%, #b5ffd0 0, #15b663 45%, #0f8b4b 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ecfdf5;
      font-weight: 700;
      font-size: 30px;
      box-shadow: 0 10px 28px rgba(16, 185, 129, 0.55);
    }

    .header-title-block h1 {
      font-size: 26px;
      line-height: 1.1;
      margin: 0 0 4px;
      letter-spacing: -0.03em;
    }

    .header-title-block p {
      margin: 0;
      color: var(--text-subtle);
      font-size: 14px;
    }

    .persona-pills {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    @media (min-width: 768px) {
      .persona-pills {
        flex-direction: row;
      }
    }

    .persona-pill {
      padding: 10px 14px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 13px;
      box-shadow: var(--shadow-light);
    }

    .persona-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: #22c55e;
    }

    .persona-dot.secondary {
      background: #6366f1;
    }

    .persona-pill-label {
      font-weight: 600;
      font-size: 13px;
    }

    .persona-pill-sub {
      color: var(--text-subtle);
      font-size: 12px;
    }

    .benefit-card {
      border-radius: var(--radius-xl);
      background: rgba(209, 250, 229, 0.9);
      border: 1px solid rgba(52, 211, 153, 0.6);
      padding: 14px 14px 16px;
      margin-top: 4px;
      display: grid;
      grid-template-columns: 1.4fr 1.2fr;
      gap: 12px;
      align-items: center;
    }

    @media (max-width: 680px) {
      .benefit-card {
        grid-template-columns: 1fr;
      }
    }

    .benefit-copy h2 {
      margin: 0 0 4px;
      font-size: 16px;
      font-weight: 600;
    }

    .benefit-copy p {
      margin: 0 0 10px;
      font-size: 13px;
      color: var(--text-subtle);
    }

    .benefit-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .benefit-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: var(--shadow-light);
      font-size: 12px;
      color: var(--text-main);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .benefit-pill-emoji {
      font-size: 15px;
    }

    .benefit-images {
      display: grid;
      grid-template-columns: 2fr 1.6fr;
      gap: 8px;
    }

    .hero-img-large,
    .hero-img-small {
      border-radius: 20px;
      overflow: hidden;
      background-size: cover;
      background-position: center;
      min-height: 90px;
      box-shadow: var(--shadow-light);
    }

    .hero-img-large {
      grid-row: span 2;
      min-height: 140px;
      background-image: url("https://images.pexels.com/photos/1640777/pexels-photo-1640777.jpeg?auto=compress&cs=tinysrgb&w=800");
    }

    .hero-img-small:nth-child(2) {
      background-image: url("https://images.pexels.com/photos/1813504/pexels-photo-1813504.jpeg?auto=compress&cs=tinysrgb&w=800");
    }

    .hero-img-small:nth-child(3) {
      background-image: url("https://images.pexels.com/photos/1639562/pexels-photo-1639562.jpeg?auto=compress&cs=tinysrgb&w=800");
    }

    /* FORM / ENGINE CARD */

    .engine-card {
      margin-top: 20px;
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      padding: 18px 16px 18px;
      box-shadow: var(--shadow-light);
      border: 1px solid var(--border-subtle);
    }

    @media (min-width: 768px) {
      .engine-card {
        padding: 22px 20px 22px;
      }
    }

    .engine-card h2 {
      margin: 0 0 4px;
      font-size: 18px;
    }

    .engine-sub {
      margin: 0 0 14px;
      font-size: 13px;
      color: var(--text-subtle);
    }

    .engine-section-title {
      font-size: 13px;
      font-weight: 600;
      margin: 18px 0 4px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #047857;
    }

    .field-row {
      display: grid;
      grid-template-columns: 1.3fr 1fr;
      gap: 10px;
    }

    @media (max-width: 600px) {
      .field-row {
        grid-template-columns: 1fr;
      }
    }

    label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-subtle);
      display: block;
      margin-bottom: 4px;
    }

    .pill-toggle-row {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: #e5f5eb;
      gap: 4px;
    }

    .pill-toggle {
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 12px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-weight: 500;
      color: #047857;
    }

    .pill-toggle.active {
      background: #22c55e;
      color: white;
      box-shadow: 0 8px 18px rgba(34, 197, 94, 0.6);
    }

    .pill-toggle-description {
      margin-top: 4px;
      font-size: 12px;
      color: var(--text-subtle);
    }

    .input-shell {
      border-radius: 999px;
      background: #f9fafb;
      border: 1px solid var(--border-subtle);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }

    .input-shell input {
      border: none;
      outline: none;
      background: transparent;
      font-size: 13px;
      width: 100%;
    }

    .hint-text {
      font-size: 11px;
      color: var(--text-subtle);
      margin-top: 4px;
    }

    .preset-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .preset-pill {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: var(--pill-bg);
      border: 1px solid var(--border-subtle);
      cursor: pointer;
      color: var(--text-subtle);
    }

    .preset-pill span {
      font-weight: 600;
      color: var(--text-main);
    }

    select,
    textarea {
      width: 100%;
      border-radius: 999px;
      padding: 8px 12px;
      border: 1px solid var(--border-subtle);
      background: #f9fafb;
      font-size: 13px;
      font-family: inherit;
      outline: none;
    }

    textarea {
      border-radius: 18px;
      resize: vertical;
      min-height: 72px;
    }

    .button-row {
      margin-top: 18px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    @media (min-width: 640px) {
      .button-row {
        flex-direction: row;
        justify-content: flex-start;
      }
    }

    .btn-primary {
      flex: 0 0 auto;
      border-radius: 999px;
      border: none;
      padding: 10px 20px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #ecfdf5;
      font-weight: 600;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 14px 30px rgba(22, 163, 74, 0.6);
      cursor: pointer;
    }

    .btn-secondary {
      flex: 0 0 auto;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 10px 18px;
      background: white;
      font-size: 13px;
      color: var(--text-main);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .btn-icon {
      font-size: 16px;
    }

    .btn-secondary[disabled],
    .btn-primary[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    /* SUMMARY / PLAN */

    .heads-up {
      margin-top: 18px;
      background: #ecfdf5;
      border-radius: 18px;
      padding: 10px 12px;
      border: 1px dashed rgba(22, 163, 74, 0.5);
      font-size: 12px;
      color: #065f46;
    }

    .plan-card {
      margin-top: 18px;
      background: white;
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-light);
      padding: 16px 14px 14px;
      display: none;
    }

    @media (min-width: 768px) {
      .plan-card {
        padding: 18px 18px 16px;
      }
    }

    .plan-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .plan-header-row h3 {
      margin: 0;
      font-size: 16px;
    }

    .bubble-summary {
      border-radius: 999px;
      padding: 8px 14px;
      background: #d1fae5;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.4);
    }

    .bubble-summary span {
      font-weight: 600;
    }

    .plan-meta {
      font-size: 11px;
      color: var(--text-subtle);
      margin-bottom: 10px;
    }

    .day-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 820px) {
      .day-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .day-column {
      background: #f9fafb;
      border-radius: 18px;
      padding: 10px 10px 12px;
      border: 1px solid var(--border-subtle);
    }

    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .day-name {
      font-size: 13px;
      font-weight: 600;
    }

    .day-cost {
      font-size: 11px;
      color: var(--text-subtle);
    }

    .meal-block {
      background: white;
      border-radius: 14px;
      padding: 8px 10px 9px;
      margin-top: 7px;
      border: 1px solid #e5e7eb;
    }

    .meal-type {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      color: #6b7280;
      text-transform: uppercase;
      margin-bottom: 2px;
    }

    .meal-name {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 4px;
    }

    .tag {
      border-radius: 999px;
      font-size: 10px;
      padding: 3px 8px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: 500;
      color: #111827;
    }

    .tag.busy {
      background: var(--tag-blue);
    }

    .tag.budget {
      background: var(--tag-green);
    }

    .tag.protein {
      background: var(--tag-orange);
    }

    .tag.quick {
      background: var(--tag-red);
    }

    .meal-meta {
      font-size: 11px;
      color: var(--text-subtle);
      margin-bottom: 4px;
    }

    .meal-how {
      font-size: 11px;
      color: var(--text-subtle);
      padding-left: 14px;
      margin: 0;
    }

    .meal-how li {
      margin-bottom: 2px;
    }

    .consolidated-card {
      margin-top: 14px;
      background: #f9fafb;
      border-radius: 18px;
      padding: 12px 12px 10px;
      border: 1px solid var(--border-subtle);
    }

    .consolidated-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }

    .consolidated-header h4 {
      margin: 0;
      font-size: 13px;
    }

    .consolidated-header span {
      font-size: 11px;
      color: var(--text-subtle);
    }

    .grocery-item {
      font-size: 11px;
      margin-bottom: 4px;
    }

    .grocery-item-name {
      font-weight: 600;
    }

    .grocery-item-meta {
      color: var(--text-subtle);
    }

    .copy-note {
      font-size: 11px;
      color: var(--text-subtle);
      margin-top: 6px;
    }

    .copy-toast {
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: #0f172a;
      color: white;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease-out, transform 0.18s ease-out;
      z-index: 999;
    }

    .copy-toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
      pointer-events: auto;
    }

    /* PDF TEMPLATE hidden container */
    #pdf-template {
      display: none;
    }

    @media (max-width: 400px) {
      .app-shell {
        border-radius: 30px;
        padding: 18px 14px 26px;
      }
      .header-card {
        border-radius: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="app-shell">
      <!-- HERO / HEADER -->
      <section class="header-card">
        <div class="header-top">
          <div class="app-avatar">H</div>
          <div class="header-title-block">
            <h1>Healthy Meal Engine</h1>
            <p>Turn your grocery budget into a simple, healthy, realistic plan.</p>
          </div>
        </div>

        <div class="persona-pills">
          <div class="persona-pill">
            <span class="persona-dot"></span>
            <div>
              <div class="persona-pill-label">Primary: Busy Worker</div>
              <div class="persona-pill-sub">Max results ‚Ä¢ minimal cooking ‚Ä¢ still healthy</div>
            </div>
          </div>
          <div class="persona-pill">
            <span class="persona-dot secondary"></span>
            <div>
              <div class="persona-pill-label">Secondary: Budget-First</div>
              <div class="persona-pill-sub">Stretch every dollar without eating trash</div>
            </div>
          </div>
        </div>

        <div class="benefit-card">
          <div class="benefit-copy">
            <h2>Eat better on a real-person budget.</h2>
            <p>No calorie math, no diet culture ‚Äî just practical meals and a grocery list that match your time, money, and cravings.</p>
            <div class="benefit-badges">
              <div class="benefit-pill">
                <span class="benefit-pill-emoji">ü•ó</span>
                <span>3 meals + snacks</span>
              </div>
              <div class="benefit-pill">
                <span class="benefit-pill-emoji">üõí</span>
                <span>Grocery list included</span>
              </div>
              <div class="benefit-pill">
                <span class="benefit-pill-emoji">üí∏</span>
                <span>Budget-aware picks</span>
              </div>
            </div>
          </div>
          <div class="benefit-images">
            <div class="hero-img-large"></div>
            <div class="hero-img-small"></div>
            <div class="hero-img-small"></div>
          </div>
        </div>
      </section>

      <!-- ENGINE -->
      <section class="engine-card">
        <h2>Build Your Week</h2>
        <p class="engine-sub">Tell the engine how you actually live. We‚Äôll return meals and a grocery list that match your budget and energy.</p>

        <!-- Focus toggle -->
        <div class="engine-section-title">1 ‚Ä¢ Who are we feeding & for how long?</div>
        <label>Focus mode</label>
        <div class="pill-toggle-row" id="focusToggle">
          <button type="button" class="pill-toggle active" data-mode="busy">Busy Worker</button>
          <button type="button" class="pill-toggle" data-mode="budget">Budget-First</button>
        </div>
        <div class="pill-toggle-description" id="focusDescription">
          Busy Worker: prioritizes quick-prep or ready-to-eat meals that still hit the health bar.
        </div>

        <!-- Budget + duration -->
        <div class="field-row" style="margin-top:12px;">
          <div>
            <label>Budget &amp; duration</label>
            <div class="input-shell">
              <span>$</span>
              <input id="budgetInput" type="number" min="10" max="400" step="1" value="60" />
              <span>/ week</span>
            </div>
            <p class="hint-text">Be honest so the math works.</p>
          </div>
          <div>
            <label>Days you want covered</label>
            <div class="input-shell">
              <input id="daysInput" type="number" min="3" max="7" step="1" value="5" />
              <span>days</span>
            </div>
            <div class="preset-row">
              <button type="button" class="preset-pill" data-days="5" data-budget="60">
                <span>Solo ‚Ä¢ 5 days</span> ¬∑ ~$60
              </button>
              <button type="button" class="preset-pill" data-days="7" data-budget="75">
                <span>Solo ‚Ä¢ 7 days</span> ¬∑ ~$75
              </button>
              <button type="button" class="preset-pill" data-days="7" data-budget="150" data-people="2">
                <span>2 people ‚Ä¢ 7 days</span> ¬∑ ~$150
              </button>
            </div>
          </div>
        </div>

        <div class="engine-section-title">2 ‚Ä¢ Food boundaries</div>
        <div class="field-row">
          <div>
            <label>Eating style</label>
            <select id="eatingStyle">
              <option value="omnivore">Omnivore (no major restrictions)</option>
              <option value="no-pork">No pork</option>
              <option value="pescatarian">Pescatarian</option>
              <option value="vegetarian">Vegetarian (eggs &amp; dairy ok)</option>
            </select>
          </div>
          <div>
            <label>Hard no ingredients</label>
            <input id="hardNo" type="text" placeholder='Comma-separated. e.g. "peanut butter, tuna, mushrooms".'
                   style="width:100%;border-radius:999px;border:1px solid var(--border-subtle);padding:8px 12px;font-size:13px;background:#f9fafb;" />
            <p class="hint-text">We‚Äôll avoid these entirely.</p>
          </div>
        </div>

        <div class="engine-section-title">3 ‚Ä¢ Lifestyle constraints (optional)</div>
        <label>Anything we should know?</label>
        <textarea id="constraints" placeholder='Short notes like "no oven", "office microwave only", "gym 3x nights".'></textarea>
        <p class="hint-text">Add context so the plan feels like your real life.</p>

        <div class="button-row">
          <button class="btn-primary" id="generateBtn">
            <span class="btn-icon">‚ú®</span>
            <span>Generate meal plan</span>
          </button>
          <button class="btn-secondary" id="pdfBtn" disabled>
            <span class="btn-icon">üìÑ</span>
            <span id="pdfBtnLabel">Download plan as PDF</span>
          </button>
        </div>

        <div class="heads-up">
          <strong>Heads up:</strong> Prices are rough estimates based on discount-grocer style pricing. Your store may vary. Re-run this anytime when your budget or schedule changes.
        </div>

        <!-- PLAN OUTPUT -->
        <section id="planOutput" class="plan-card">
          <div class="plan-header-row">
            <h3>Your Weekly Plan</h3>
            <div class="bubble-summary" id="budgetBubble">
              Total budget: $60 ‚Ä¢ Estimated food cost: $46.8
            </div>
          </div>
          <div class="plan-meta" id="planMeta">
            ~$13.2 under budget (buffer for tax / price swings). Focus: Busy Worker ‚Äî prioritizing quick-prep or ready-to-eat meals.
          </div>
          <div class="day-grid" id="dayGrid"></div>

          <div class="consolidated-card">
            <div class="consolidated-header">
              <h4>Consolidated grocery list</h4>
              <span id="grocerySummary">39 unique items ¬∑ Est. food cost: $46.8 (before tax)</span>
            </div>
            <div id="groceryList"></div>
            <p class="copy-note">
              Tap ‚ÄúDownload plan as PDF‚Äù for a clean version you can save or print, or long-press ‚Üí copy to paste into Notes or your grocery app.
            </p>
          </div>
        </section>
      </section>
    </div>
  </div>

  <!-- Hidden container for PDF HTML -->
  <div id="pdf-template"></div>

  <div class="copy-toast" id="toast">Copied!</div>

  <script>
    let pdfReady = typeof html2pdf !== "undefined";

    const ingredientsCatalog = {
      "milk_or_water": { name: "Milk or water", category: "Fridge & basics", baseCost: 3.0, store: "Any grocery / big-box" },
      "water": { name: "Water", category: "Fridge & basics", baseCost: 3.0, store: "Any grocery store / big-box" },
      "flavor_drops": { name: "Flavor drops", category: "Pantry", baseCost: 4.0, store: "Any grocery store / big-box" },
      "whole_grain_bread": { name: "Whole grain bread", category: "Bakery", baseCost: 3.0, store: "Bakery or bread aisle (any grocery)" },
      "tortillas": { name: "Tortillas", category: "Bakery", baseCost: 3.0, store: "Bread/tortilla aisle (any grocery)" },
      "chia_seeds": { name: "Chia seeds", category: "Pantry", baseCost: 5.0, store: "Bulk aisle or online (Amazon)" },
      "canned_tuna": { name: "Canned tuna", category: "Pantry", baseCost: 4.0, store: "Canned goods aisle (any grocery)" },
      "granola": { name: "Granola", category: "Pantry", baseCost: 5.0, store: "Cereal aisle (big-box or grocery)" },
      "feta": { name: "Feta", category: "Fridge", baseCost: 4.0, store: "Cheese section (any grocery)" },
      "oat_milk": { name: "Oat or almond milk", category: "Fridge", baseCost: 4.0, store: "Dairy alternative section (any grocery)" },
      "chicken_thighs": { name: "Chicken thighs", category: "Protein", baseCost: 8.0, store: "Discount grocer (Aldi/Lidl/Walmart)" },
      "rolled_oats": { name: "Rolled oats", category: "Pantry", baseCost: 3.0, store: "Discount grocer or bulk aisle" },
      "frozen_salmon": { name: "Frozen salmon", category: "Freezer", baseCost: 10.0, store: "Freezer / seafood section" },
      "frozen_grain_bowl": { name: "Frozen grain veggie bowl", category: "Freezer", baseCost: 5.0, store: "Freezer aisle (big-box / grocery)" },
      "frozen_berries": { name: "Frozen berries", category: "Freezer", baseCost: 4.0, store: "Freezer aisle (discount grocer or big-box)" },
      "frozen_green_beans": { name: "Frozen green beans", category: "Freezer", baseCost: 3.0, store: "Frozen or produce section" },
      "rotisserie_chicken": { name: "Rotisserie chicken", category: "Protein", baseCost: 8.0, store: "Grocery deli / hot foods" },
      "olive_oil": { name: "Olive oil", category: "Pantry", baseCost: 6.0, store: "Oils aisle (any grocery store / big-box)" },
      "protein_powder": { name: "Protein powder", category: "Pantry", baseCost: 18.0, store: "Online/big-box (Amazon, Walmart, Target)" },
      "peanut_butter": { name: "Peanut butter", category: "Pantry", baseCost: 3.0, store: "Peanut butter/jam aisle" },
      "pickles_celery": { name: "Pickles or celery", category: "Produce", baseCost: 3.0, store: "Pickle aisle or produce" },
      "bananas": { name: "Bananas", category: "Produce", baseCost: 3.0, store: "Produce section (any grocery)" },
      "cucumber": { name: "Cucumber", category: "Produce", baseCost: 2.0, store: "Produce section (any grocery)" },
      "carrots": { name: "Carrots", category: "Produce", baseCost: 3.0, store: "Produce section (any grocery)" },
      "baby_potatoes": { name: "Baby potatoes", category: "Produce", baseCost: 3.0, store: "Produce section (any grocery)" },
      "apples": { name: "Apples", category: "Produce", baseCost: 3.0, store: "Produce section (any grocery)" },
      "lemons": { name: "Lemons", category: "Produce", baseCost: 3.0, store: "Produce section (any grocery)" },
      "baby_carrots": { name: "Baby carrots", category: "Produce", baseCost: 2.0, store: "Produce section (any grocery)" },
      "spinach": { name: "Spinach", category: "Produce", baseCost: 2.0, store: "Produce section (any grocery)" },
      "greek_yogurt": { name: "Greek yogurt", category: "Fridge", baseCost: 5.0, store: "Refrigerated dairy (any grocery)" },
      "hummus": { name: "Hummus", category: "Fridge", baseCost: 4.0, store: "Refrigerated dips (any grocery)" },
      "rice": { name: "Rice", category: "Pantry", baseCost: 4.0, store: "Rice/grains aisle (any grocery)" },
      "protein_bars": { name: "Protein bars", category: "Snacks", baseCost: 7.0, store: "Snacks or nutrition aisle (big-box/grocery)" },
      "seasoning_blend": { name: "Seasoning blend", category: "Pantry", baseCost: 3.0, store: "Spice aisle (any grocery)" },
      "green_tea": { name: "Green tea bags", category: "Pantry", baseCost: 3.0, store: "Tea/coffee aisle" }
    };

    const mealsLibrary = [
      {
        id: "overnight_oats",
        type: "Breakfast",
        name: "Overnight oats with chia & banana",
        tags: ["busy", "budget", "quick", "protein"],
        prepMinutes: 5,
        approxCost: 1.5,
        ingredients: {
          rolled_oats: 0.10,
          chia_seeds: 0.08,
          bananas: 0.15,
          oat_milk: 0.10
        },
        steps: [
          "Add oats, chia seeds, and cinnamon (optional) to a jar or container.",
          "Pour in enough milk to fully cover the oats and stir.",
          "Refrigerate overnight; add sliced banana in the morning."
        ]
      },
      {
        id: "hummus_wrap",
        type: "Lunch",
        name: "Hummus, veggie & feta wrap",
        tags: ["busy", "quick", "budget"],
        prepMinutes: 7,
        approxCost: 2.5,
        ingredients: {
          hummus: 0.10,
          tortillas: 0.15,
          cucumber: 0.15,
          carrots: 0.10,
          feta: 0.10,
          spinach: 0.10
        },
        steps: [
          "Spread hummus over the tortilla.",
          "Add sliced cucumber, shredded carrots, spinach and a sprinkle of feta.",
          "Roll up tightly and slice in half if desired."
        ]
      },
      {
        id: "sheet_pan_chicken",
        type: "Dinner",
        name: "Sheet pan chicken, potatoes & carrots",
        tags: ["budget", "protein"],
        prepMinutes: 15,
        approxCost: 3.0,
        ingredients: {
          chicken_thighs: 0.30,
          baby_potatoes: 0.25,
          carrots: 0.20,
          olive_oil: 0.08,
          seasoning_blend: 0.05
        },
        steps: [
          "Preheat oven to ~400¬∞F (200¬∞C) and line a sheet pan.",
          "Toss chicken, chopped potatoes, and carrots with olive oil and seasoning.",
          "Spread on the pan and roast 25‚Äì35 minutes until cooked through and browned."
        ]
      },
      {
        id: "salmon_rice_beans",
        type: "Dinner",
        name: "Baked salmon, rice & green beans",
        tags: ["protein"],
        prepMinutes: 12,
        approxCost: 4.2,
        ingredients: {
          frozen_salmon: 0.25,
          rice: 0.20,
          frozen_green_beans: 0.20,
          olive_oil: 0.10,
          lemons: 0.10
        },
        steps: [
          "Preheat oven to ~400¬∞F (200¬∞C). Place salmon on a lined tray.",
          "Drizzle with olive oil, salt, pepper, and lemon.",
          "Bake salmon 12‚Äì18 minutes depending on thickness.",
          "Cook rice and steam or microwave green beans; serve together."
        ]
      },
      {
        id: "greek_yogurt_bowl",
        type: "Breakfast",
        name: "Greek yogurt + berries + granola",
        tags: ["busy", "budget", "protein", "quick"],
        prepMinutes: 3,
        approxCost: 2.4,
        ingredients: {
          greek_yogurt: 0.25,
          frozen_berries: 0.25,
          granola: 0.25
        },
        steps: [
          "Scoop Greek yogurt into a bowl or container.",
          "Top with a handful of frozen berries.",
          "Sprinkle granola on top right before eating so it stays crunchy."
        ]
      },
      {
        id: "tuna_toast",
        type: "Lunch",
        name: "Tuna salad on whole grain toast",
        tags: ["budget", "protein"],
        prepMinutes: 8,
        approxCost: 2.0,
        ingredients: {
          canned_tuna: 0.25,
          greek_yogurt: 0.05,
          pickles_celery: 0.08,
          whole_grain_bread: 0.15
        },
        steps: [
          "Drain canned tuna and add to a bowl.",
          "Mix with Greek yogurt or light mayo and chopped pickles/celery.",
          "Toast bread and spread tuna salad on top."
        ]
      },
      {
        id: "protein_smoothie",
        type: "Breakfast",
        name: "Protein smoothie (frozen fruit + protein powder)",
        tags: ["busy", "protein", "quick"],
        prepMinutes: 4,
        approxCost: 2.2,
        ingredients: {
          frozen_berries: 0.20,
          protein_powder: 0.10,
          oat_milk: 0.10,
          spinach: 0.05
        },
        steps: [
          "Add frozen fruit, protein powder, and milk to a blender.",
          "Optional: add a handful of spinach.",
          "Blend until smooth; adjust liquid for desired thickness."
        ]
      },
      {
        id: "carrots_hummus",
        type: "Snacks",
        name: "Carrots & hummus",
        tags: ["busy", "budget", "quick"],
        prepMinutes: 2,
        approxCost: 0.9,
        ingredients: {
          baby_carrots: 0.30,
          hummus: 0.10
        },
        steps: [
          "Portion baby carrots into a container.",
          "Add a scoop of hummus as a dip."
        ]
      },
      {
        id: "apple_pb",
        type: "Snacks",
        name: "Apple + peanut butter",
        tags: ["budget", "quick"],
        prepMinutes: 2,
        approxCost: 1.0,
        ingredients: {
          apples: 0.20,
          peanut_butter: 0.15
        },
        steps: [
          "Slice an apple just before eating.",
          "Serve with a spoonful or two of peanut butter for dipping."
        ]
      },
      {
        id: "protein_bar",
        type: "Snacks",
        name: "Low-sugar protein bar",
        tags: ["busy", "protein", "quick"],
        prepMinutes: 1,
        approxCost: 1.5,
        ingredients: {
          protein_bars: 0.20
        },
        steps: [
          "Keep a few bars in your bag, desk, or car.",
          "Grab one when you need quick protein on the go."
        ]
      },
      {
        id: "green_tea",
        type: "Beverages",
        name: "Green tea",
        tags: ["budget", "quick"],
        prepMinutes: 3,
        approxCost: 0.4,
        ingredients: {
          green_tea: 0.10
        },
        steps: [
          "Boil water and let it sit 1‚Äì2 minutes to cool slightly.",
          "Steep green tea bag 2‚Äì3 minutes.",
          "Remove bag to avoid bitterness."
        ]
      },
      {
        id: "water_lemon",
        type: "Beverages",
        name: "Water + flavor drops or lemon",
        tags: ["budget", "quick"],
        prepMinutes: 1,
        approxCost: 0.1,
        ingredients: {
          water: 0.10,
          flavor_drops: 0.05,
          lemons: 0.05
        },
        steps: [
          "Fill a bottle or large cup with water.",
          "Squeeze in lemon or add a small amount of flavor drops.",
          "Sip throughout the day."
        ]
      }
    ];

    const daysOfWeek = ["Day 1", "Day 2", "Day 3", "Day 4", "Day 5", "Day 6", "Day 7"];
    let currentPlan = null;

    function clamp(value, min, max) {
      return Math.min(max, Math.max(min, value));
    }

    function getUseLabel(value) {
      if (value <= 0.3) return "Light use";
      if (value <= 0.7) return "Moderate use";
      if (value <= 1.3) return "Weekly amount";
      return "Heavy use / stock up";
    }

    function formatCurrency(num) {
      return "$" + num.toFixed(1);
    }

    function toast(message) {
      const t = document.getElementById("toast");
      t.textContent = message;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 1700);
    }

    function buildPlan() {
      const mode = document
        .querySelector(".pill-toggle.active")
        .getAttribute("data-mode");

      const budget = clamp(parseFloat(document.getElementById("budgetInput").value || "60"), 15, 400);
      const days = clamp(parseInt(document.getElementById("daysInput").value || "5", 10), 3, 7);
      const eatingStyle = document.getElementById("eatingStyle").value;
      const hardNos = (document.getElementById("hardNo").value || "")
        .toLowerCase()
        .split(",")
        .map((s) => s.trim())
        .filter(Boolean);
      const constraints = document.getElementById("constraints").value.trim();

      let mealPool = mealsLibrary.slice();
      if (eatingStyle === "pescatarian") {
        mealPool = mealPool.filter((m) => !m.id.includes("chicken"));
      } else if (eatingStyle === "vegetarian") {
        mealPool = mealPool.filter(
          (m) =>
            !m.id.includes("tuna") &&
            !m.id.includes("salmon") &&
            !m.id.includes("chicken") &&
            !m.id.includes("rotisserie")
        );
      }

      if (hardNos.length) {
        mealPool = mealPool.filter((meal) => {
          const lowerName = meal.name.toLowerCase();
          return !hardNos.some((no) => no && lowerName.includes(no));
        });
      }

      const breakfasts = mealPool.filter((m) => m.type === "Breakfast");
      const lunches = mealPool.filter((m) => m.type === "Lunch");
      const dinners = mealPool.filter((m) => m.type === "Dinner");
      const snacks = mealPool.filter((m) => m.type === "Snacks");
      const beverages = mealPool.filter((m) => m.type === "Beverages");

      function pick(list, index) {
        if (!list.length) return null;
        return list[index % list.length];
      }

      const daysPlan = [];
      const ingredientTotals = {};

      for (let i = 0; i < days; i++) {
        const dayLabel = daysOfWeek[i];
        const dayMeals = {
          breakfast: pick(breakfasts, i),
          lunch: pick(lunches, i),
          dinner: pick(mode === "busy" ? dinners : dinners.reverse(), i),
          snack: pick(snacks, i),
          beverage: pick(beverages, i)
        };

        Object.values(dayMeals).forEach((meal) => {
          if (!meal || !meal.ingredients) return;
          Object.entries(meal.ingredients).forEach(([key, val]) => {
            if (!ingredientsCatalog[key]) return;
            ingredientTotals[key] = (ingredientTotals[key] || 0) + val;
          });
        });

        let dailyCost = 0;
        Object.values(dayMeals).forEach((meal) => {
          if (!meal) return;
          dailyCost += meal.approxCost || 0;
        });

        daysPlan.push({
          label: dayLabel,
          cost: dailyCost,
          meals: dayMeals
        });
      }

      let estimatedCost = 0;
      Object.entries(ingredientTotals).forEach(([id, uses]) => {
        const ing = ingredientsCatalog[id];
        if (!ing) return;
        const intensity = uses;
        const multiplier = clamp(intensity, 0.3, 1.2);
        estimatedCost += ing.baseCost * multiplier;
      });

      const minCost = budget * 0.65;
      const maxCost = budget * 0.95;
      estimatedCost = clamp(estimatedCost, minCost, maxCost);

      const underOver = budget - estimatedCost;
      const metaFocus =
        mode === "busy"
          ? "Busy Worker ‚Äî prioritizing quick-prep or ready-to-eat meals."
          : "Budget-First ‚Äî nudging toward cheaper ingredients while staying reasonable.";

      const groceryEntries = Object.entries(ingredientTotals).map(([id, uses]) => {
        const i = ingredientsCatalog[id];
        const label = getUseLabel(uses);
        const usesRounded = uses.toFixed(1);
        const cost = i.baseCost;
        let range = `$${Math.round(cost - 1)}‚Äì$${Math.round(cost + 1)}`;
        if (cost <= 3) range = "$2‚Äì$4";
        if (cost >= 6 && cost < 10) range = "$5‚Äì$9";
        if (cost >= 10) range = `$${Math.round(cost - 1)}‚Äì$${Math.round(cost + 2)}`;
        return {
          id,
          name: i.name,
          category: i.category,
          uses,
          usesRounded,
          useLabel: label,
          budgetRange: range,
          store: i.store
        };
      });

      groceryEntries.sort((a, b) => a.category.localeCompare(b.category) || a.name.localeCompare(b.name));

      currentPlan = {
        mode,
        budget,
        days,
        eatingStyle,
        constraints,
        daysPlan,
        groceryEntries,
        estimatedCost,
        underOver,
        metaFocus
      };

      renderPlan();
    }

    function renderPlan() {
      if (!currentPlan) return;

      const planOutput = document.getElementById("planOutput");
      planOutput.style.display = "block";

      const { budget, estimatedCost, underOver, days, mode, daysPlan, groceryEntries, metaFocus } =
        currentPlan;

      const bubble = document.getElementById("budgetBubble");
      bubble.textContent = `Total budget: $${budget.toFixed(
        0
      )} ‚Ä¢ Estimated food cost: ${formatCurrency(estimatedCost)}`;

      const meta = document.getElementById("planMeta");
      const diffAbs = Math.abs(underOver).toFixed(1);
      const diffText =
        underOver >= 0
          ? `~$${diffAbs} under budget (buffer for tax / price swings).`
          : `~$${diffAbs} over budget ‚Äî consider trimming snacks or portions.`;
      meta.textContent = `${diffText} Focus: ${
        mode === "busy" ? "Busy Worker" : "Budget-First"
      } ‚Äî ${metaFocus.replace("Busy Worker ‚Äî ", "").replace("Budget-First ‚Äî ", "")}`;

      const dayGrid = document.getElementById("dayGrid");
      dayGrid.innerHTML = "";

      daysPlan.forEach((day) => {
        const col = document.createElement("div");
        col.className = "day-column";
        const costDisplay = `Est. daily cost: ${formatCurrency(day.cost)}`;
        col.innerHTML = `
          <div class="day-header">
            <div class="day-name">${day.label}</div>
            <div class="day-cost">${costDisplay}</div>
          </div>
        `;
        const types = [
          ["Breakfast", day.meals.breakfast],
          ["Lunch", day.meals.lunch],
          ["Dinner", day.meals.dinner],
          ["Snacks", day.meals.snack],
          ["Beverages", day.meals.beverage]
        ];
        types.forEach(([label, meal]) => {
          if (!meal) return;
          const block = document.createElement("div");
          block.className = "meal-block";
          const tagsHtml = (meal.tags || [])
            .map((t) => {
              let cls = "budget";
              if (t === "busy") cls = "busy";
              else if (t === "protein") cls = "protein";
              else if (t === "quick") cls = "quick";
              return `<span class="tag ${cls}">${t.replace("-", " ")}</span>`;
            })
            .join("");
          const stepsHtml = (meal.steps || [])
            .map((s) => `<li>${s}</li>`)
            .join("");
          block.innerHTML = `
            <div class="meal-type">${label.toUpperCase()}</div>
            <div class="meal-name">${meal.name}</div>
            <div class="tag-row">${tagsHtml}</div>
            <div class="meal-meta">${meal.prepMinutes} min ‚Ä¢ ~${formatCurrency(
            meal.approxCost
          )}/serv</div>
            <ul class="meal-how">${stepsHtml}</ul>
          `;
          col.appendChild(block);
        });
        dayGrid.appendChild(col);
      });

      const grocerySummary = document.getElementById("grocerySummary");
      grocerySummary.textContent = `${groceryEntries.length} unique items ¬∑ Est. food cost: ${formatCurrency(
        estimatedCost
      )} (before tax)`;

      const groceryDiv = document.getElementById("groceryList");
      groceryDiv.innerHTML = "";

      let currentCategory = null;
      groceryEntries.forEach((item) => {
        if (item.category !== currentCategory) {
          currentCategory = item.category;
          const catHeader = document.createElement("div");
          catHeader.style.margin = "6px 0 4px";
          catHeader.style.fontSize = "11px";
          catHeader.style.fontWeight = "600";
          catHeader.style.textTransform = "uppercase";
          catHeader.style.letterSpacing = "0.07em";
          catHeader.style.color = "#6b7280";
          catHeader.textContent = currentCategory;
          groceryDiv.appendChild(catHeader);
        }
        const row = document.createElement("div");
        row.className = "grocery-item";
        row.innerHTML = `
          <span class="grocery-item-name">${item.name}</span>
          <span class="grocery-item-meta">
            ‚Äî ~${item.usesRounded} uses this week, budget: ${item.budgetRange} ‚Ä¢ ${item.store}
          </span>
        `;
        groceryDiv.appendChild(row);
      });

      document.getElementById("pdfBtn").disabled = false;
    }

    function buildPdfHtml() {
      if (!currentPlan) return "";
      const {
        budget,
        estimatedCost,
        underOver,
        days,
        mode,
        metaFocus,
        daysPlan,
        groceryEntries,
        eatingStyle,
        constraints
      } = currentPlan;

      const diffAbs = Math.abs(underOver).toFixed(1);
      const diffText =
        underOver >= 0
          ? `About $${diffAbs} under budget (buffer for tax & price swings).`
          : `About $${diffAbs} over budget ‚Äî consider trimming snacks or portions.`;

      const modeLabel = mode === "busy" ? "Busy Worker" : "Budget-First";

      const metaLine = `${diffText} Focus: ${modeLabel}. Eating style: ${eatingStyle.replace("-", " ")}.`;
      const constraintLine = constraints
        ? `<p style="font-size:11px;margin:4px 0 10px;"><strong>Special notes:</strong> ${constraints}</p>`
        : "";

      const daySections = daysPlan
        .map((day) => {
          const mealLines = [];
          const types = [
            ["Breakfast", day.meals.breakfast],
            ["Lunch", day.meals.lunch],
            ["Dinner", day.meals.dinner],
            ["Snacks", day.meals.snack],
            ["Beverages", day.meals.beverage]
          ];
          types.forEach(([label, meal]) => {
            if (!meal) return;
            const steps = (meal.steps || [])
              .map((s) => `<li>${s}</li>`)
              .join("");
            mealLines.push(`
              <div style="margin-bottom:8px;padding:6px 8px;border-radius:8px;border:1px solid #e5e7eb;background:#ffffff;">
                <div style="font-size:11px;color:#6b7280;font-weight:600;text-transform:uppercase;letter-spacing:0.06em;">${label}</div>
                <div style="font-size:12px;font-weight:600;margin:1px 0 2px;">${meal.name}</div>
                <div style="font-size:11px;color:#6b7280;margin-bottom:2px;">${meal.prepMinutes} min ‚Ä¢ ~${formatCurrency(
              meal.approxCost
            )}/serv</div>
                <ul style="margin:0 0 2px 16px;padding:0;font-size:11px;color:#4b5563;">${steps}</ul>
              </div>
            `);
          });
          return `
            <div style="page-break-inside:avoid;margin-bottom:12px;padding:8px 10px;border-radius:10px;border:1px solid #e5e7eb;background:#f9fafb;">
              <div style="display:flex;justify-content:space-between;font-size:12px;font-weight:600;margin-bottom:4px;">
                <span>${day.label}</span>
                <span>Est. daily cost: ${formatCurrency(day.cost)}</span>
              </div>
              ${mealLines.join("")}
            </div>
          `;
        })
        .join("");

      let currentCategory = null;
      const groceryLines = groceryEntries
        .map((item) => {
          let catHeaderHtml = "";
          if (item.category !== currentCategory) {
            currentCategory = item.category;
            catHeaderHtml = `<div style="margin:6px 0 3px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.07em;color:#6b7280;">${currentCategory}</div>`;
          }
          return `
            ${catHeaderHtml}
            <div style="font-size:11px;margin-bottom:3px;">
              <strong>${item.name}</strong>
              <span> ‚Äî ~${item.usesRounded} uses this week, budget: ${item.budgetRange} ‚Ä¢ ${item.store}</span>
            </div>
          `;
        })
        .join("");

      // COVER + OVERVIEW + DAILY + GROCERY LIST
      return `
        <div style="font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;font-size:12px;color:#111827;padding:10px;">
          <!-- COVER SECTION -->
          <section style="page-break-after:always;">
            <div style="display:flex;gap:12px;align-items:stretch;">
              <div style="flex:1.4;">
                <h1 style="font-size:20px;margin:0 0 4px;color:#065f46;">Your Personalized Weekly Healthy Meal Plan</h1>
                <p style="font-size:11px;margin:0 0 10px;color:#4b5563;">
                  Built to match your budget, energy, and eating style. Print this or keep it on your phone for the week.
                </p>
                <div style="font-size:11px;margin:6px 0 4px;padding:8px 10px;border-radius:10px;background:#ecfdf5;border:1px solid #bbf7d0;">
                  <div><strong>Total budget:</strong> $${budget.toFixed(0)}</div>
                  <div><strong>Estimated food cost:</strong> ${formatCurrency(estimatedCost)} (before tax)</div>
                  <div><strong>Coverage:</strong> ${days} days ¬∑ <strong>Focus:</strong> ${modeLabel}</div>
                  <div><strong>Eating style:</strong> ${eatingStyle.replace("-", " ")}</div>
                </div>
                <p style="font-size:11px;margin:6px 0 4px;color:#4b5563;">${metaLine}</p>
                ${constraintLine}
                <p style="font-size:10px;margin:10px 0 0;color:#6b7280;">
                  Generated with Healthy Meal Engine. This is not a medical or nutrition prescription ‚Äî just a practical, budget-aware planning guide.
                </p>
              </div>
              <div style="flex:1.2;display:grid;grid-template-columns:2fr 1.5fr;gap:6px;">
                <!-- Collage layout A: 2 small left, 1 tall right -->
                <div style="grid-row:1 / span 2;border-radius:14px;overflow:hidden;background:url('https://images.pexels.com/photos/1640777/pexels-photo-1640777.jpeg?auto=compress&cs=tinysrgb&w=800') center/cover no-repeat;"></div>
                <div style="border-radius:14px;overflow:hidden;background:url('https://images.pexels.com/photos/1813504/pexels-photo-1813504.jpeg?auto=compress&cs=tinysrgb&w=800') center/cover no-repeat;"></div>
                <div style="border-radius:14px;overflow:hidden;background:url('https://images.pexels.com/photos/1639562/pexels-photo-1639562.jpeg?auto=compress&cs=tinysrgb&w=800') center/cover no-repeat;"></div>
              </div>
            </div>
          </section>

          <!-- WEEK OVERVIEW + DAILY PLAN -->
          <section>
            <h2 style="font-size:14px;margin:0 0 4px;color:#047857;">Week overview</h2>
            <p style="font-size:11px;margin:0 0 8px;color:#4b5563;">
              Each day includes a simple structure: breakfast, lunch, dinner, snack, and hydration. Use this as a guide, not a rigid rulebook.
            </p>
            ${daySections}
          </section>

          <section style="page-break-before:always;">
            <h2 style="font-size:14px;margin:4px 0 4px;color:#047857;">Consolidated grocery list</h2>
            <p style="font-size:11px;margin:0 0 6px;color:#4b5563;">
              Grouped by section so you can move quickly through the store. Prices assume discount-grocer style stores; your local store may vary.
            </p>
            ${groceryLines}
            <p style="font-size:10px;margin:10px 0 0;color:#6b7280;">
              Healthy Meal Engine ¬∑ v1.5 ¬∑ Prices are rough estimates based on national discount-grocer averages.
              Re-run this plan whenever your budget, schedule, or preferences change.
            </p>
          </section>
        </div>
      `;
    }

    function generatePdf() {
      if (!pdfReady || typeof html2pdf === "undefined") {
        alert("PDF tools didn‚Äôt load correctly. Please refresh the page and try again.");
        return;
      }
      if (!currentPlan) {
        alert("Generate a meal plan first.");
        return;
      }

      const pdfBtn = document.getElementById("pdfBtn");
      const pdfBtnLabel = document.getElementById("pdfBtnLabel");
      pdfBtn.disabled = true;
      pdfBtnLabel.textContent = "Preparing PDF‚Ä¶";

      const pdfContainer = document.getElementById("pdf-template");
      pdfContainer.innerHTML = buildPdfHtml();

      const opt = {
        margin: 10,
        filename: "Healthy-Meal-Plan.pdf",
        image: { type: "jpeg", quality: 0.95 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
        pagebreak: { mode: ["css", "legacy"] }
      };

      html2pdf()
        .set(opt)
        .from(pdfContainer)
        .save()
        .then(() => {
          pdfBtn.disabled = false;
          pdfBtnLabel.textContent = "Download plan as PDF";
        })
        .catch(() => {
          alert("Something went wrong while building the PDF. Please try again.");
          pdfBtn.disabled = false;
          pdfBtnLabel.textContent = "Download plan as PDF";
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (typeof html2pdf !== "undefined") {
        pdfReady = true;
      }

      const focusToggle = document.getElementById("focusToggle");
      const focusDescription = document.getElementById("focusDescription");

      focusToggle.addEventListener("click", (e) => {
        const btn = e.target.closest(".pill-toggle");
        if (!btn) return;
        focusToggle.querySelectorAll(".pill-toggle").forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        const mode = btn.getAttribute("data-mode");
        focusDescription.textContent =
          mode === "busy"
            ? "Busy Worker: prioritizes quick-prep or ready-to-eat meals that still hit the health bar."
            : "Budget-First: nudges the engine toward cheaper ingredients and pantry staples while staying reasonable.";
      });

      document.querySelectorAll(".preset-pill").forEach((pill) => {
        pill.addEventListener("click", () => {
          const days = pill.getAttribute("data-days");
          const budget = pill.getAttribute("data-budget");
          if (days) document.getElementById("daysInput").value = days;
          if (budget) document.getElementById("budgetInput").value = budget;
        });
      });

      document.getElementById("generateBtn").addEventListener("click", () => {
        buildPlan();
        toast("Plan updated ‚úîÔ∏è");
      });

      document.getElementById("pdfBtn").addEventListener("click", () => {
        generatePdf();
      });
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Healthy Meal Engine</title>

  <style>
    :root{
      --bg1:#eaf8f1;
      --bg2:#f6fff9;
      --card:#ffffff;
      --ink:#0b1b14;
      --muted:#5c6b64;
      --stroke:rgba(10,30,20,.12);
      --shadow:0 14px 40px rgba(0,0,0,.08);
      --green:#1fb86a;
      --green2:#0ea85a;
      --pill:rgba(31,184,106,.14);
      --blue:#3b82f6;
      --warn:#ffb020;
      --red:#ef4444;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--ink);
      background: radial-gradient(1200px 600px at 30% -10%, rgba(31,184,106,.22), transparent 55%),
                  radial-gradient(900px 500px at 85% 15%, rgba(59,130,246,.12), transparent 50%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      padding:24px 14px 48px;
    }

    .wrap{ max-width: 820px; margin:0 auto; }
    .shell{
      border:1px solid var(--stroke);
      border-radius:28px;
      background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.92));
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .top{
      padding:22px 22px 10px;
    }
    .brand{
      display:flex; gap:14px; align-items:flex-start;
    }
    .logo{
      width:56px; height:56px; border-radius:18px;
      background: radial-gradient(circle at 30% 30%, #77ffb8, #18a45d 55%, #0b7f44);
      box-shadow: 0 16px 30px rgba(31,184,106,.25);
      display:flex; align-items:center; justify-content:center;
      color:white; font-weight:800; letter-spacing:.02em;
      flex:0 0 auto;
    }
    .title h1{ margin:0; font-size:30px; line-height:1.08; }
    .title p{ margin:6px 0 0; color:var(--muted); font-size:14.5px; }

    .focus-chips{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:14px;
    }
    .chip{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.75);
      border-radius:18px;
      padding:12px 12px;
      display:flex; gap:10px; align-items:flex-start;
    }
    .dot{
      width:10px; height:10px; border-radius:6px; margin-top:4px;
      background: var(--green);
      box-shadow:0 0 0 4px rgba(31,184,106,.14);
      flex:0 0 auto;
    }
    .dot.blue{
      background: #5b7cfa;
      box-shadow:0 0 0 4px rgba(91,124,250,.12);
    }
    .chip b{ display:block; font-size:13.5px; }
    .chip span{ display:block; color:var(--muted); font-size:12.5px; margin-top:2px; }

    .hero{
      margin:14px 22px 18px;
      border-radius:22px;
      border:1px solid rgba(31,184,106,.22);
      background: linear-gradient(180deg, rgba(31,184,106,.10), rgba(255,255,255,.60));
      padding:16px 16px 14px;
    }
    .hero h2{ margin:0 0 6px; font-size:18px; }
    .hero p{ margin:0 0 12px; color:var(--muted); line-height:1.35; }

    .bullets{ display:flex; flex-wrap:wrap; gap:8px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      background: rgba(255,255,255,.68);
      border:1px solid var(--stroke);
      padding:8px 10px;
      border-radius:999px;
      font-size:12.5px;
      color:#123024;
    }
    .pill i{ font-style:normal; opacity:.85; }

    .photo-grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:10px;
      align-items:stretch;
    }
    .photo{
      border-radius:18px;
      border:1px solid var(--stroke);
      overflow:hidden;
      position:relative;
      background:#e9f7ef;
      min-height:124px;
    }
    .photo.big{
      min-height:154px;
    }
    .photo img{
      width:100%; height:100%; object-fit:cover; display:block;
      filter:saturate(1.02) contrast(1.02);
    }
    .photo-stack{
      display:grid; grid-template-rows: 1fr 1fr; gap:10px;
    }

    .section{
      padding:18px 22px 22px;
      border-top:1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.72);
    }
    .section h3{ margin:0; font-size:18px; }
    .section .sub{ margin:6px 0 14px; color:var(--muted); font-size:13.5px; }

    .card{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.92);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 10px 22px rgba(0,0,0,.04);
    }

    .step{ display:flex; gap:10px; align-items:center; margin-bottom:10px; }
    .step .num{
      width:24px; height:24px; border-radius:10px;
      background: rgba(31,184,106,.18);
      color:#0f3a26;
      display:flex; align-items:center; justify-content:center;
      font-weight:800; font-size:12px;
      border:1px solid rgba(31,184,106,.22);
    }
    .step b{ font-size:13px; }
    .step small{ color:var(--muted); display:block; margin-top:2px; }

    .toggle{
      display:flex;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.8);
      overflow:hidden;
      padding:4px;
      gap:4px;
      margin:10px 0 12px;
    }
    .toggle button{
      flex:1;
      border:0;
      background: transparent;
      padding:10px 10px;
      font-weight:700;
      border-radius:999px;
      cursor:pointer;
      color:#1a3a2b;
    }
    .toggle button.active{
      background: linear-gradient(180deg, var(--green), var(--green2));
      color:white;
      box-shadow: 0 10px 18px rgba(31,184,106,.25);
    }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row-3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    @media (max-width: 760px){
      .focus-chips{ grid-template-columns:1fr; }
      .row,.row-3{ grid-template-columns:1fr; }
      .photo-grid{ grid-template-columns:1fr; }
      .photo-stack{ grid-template-rows:auto; grid-template-columns:1fr 1fr; }
    }

    label{ display:block; font-size:12px; font-weight:800; color:#173326; margin-bottom:6px; }
    input, select, textarea{
      width:100%;
      border-radius:14px;
      border:1px solid var(--stroke);
      padding:12px 12px;
      font-size:14px;
      background: rgba(255,255,255,.95);
      outline:none;
    }
    textarea{ min-height:56px; resize:vertical; }

    .hint{
      margin-top:8px;
      font-size:12.5px;
      color:var(--muted);
    }
    .hint strong{ color:#123024; }

    .actions{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:12px;
    }
    .btn{
      border:0;
      border-radius:999px;
      padding:12px 14px;
      font-weight:800;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:10px;
      background: linear-gradient(180deg, var(--green), var(--green2));
      color:white;
      box-shadow: 0 14px 28px rgba(31,184,106,.25);
    }
    .btn.secondary{
      background: rgba(255,255,255,.92);
      color:#123024;
      border:1px solid var(--stroke);
      box-shadow:none;
    }
    .btn:disabled{
      opacity:.6; cursor:not-allowed;
    }

    .notice{
      margin-top:12px;
      border-radius:16px;
      border:1px dashed rgba(31,184,106,.34);
      background: rgba(31,184,106,.08);
      padding:12px 12px;
      color:#1b3d2c;
      font-size:12.8px;
      line-height:1.35;
    }

    .out{
      margin-top:14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.95);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 10px 22px rgba(0,0,0,.04);
    }
    .out h4{ margin:0 0 8px; font-size:18px; }
    .summary{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin:10px 0 12px;
    }
    .mini{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.92);
      border-radius:16px;
      padding:10px 10px;
    }
    .mini b{ display:block; font-size:12px; color:#173326; }
    .mini span{ display:block; margin-top:4px; color:var(--muted); font-size:12.5px; }

    @media (max-width:760px){ .summary{ grid-template-columns:1fr; } }

    .days{ display:grid; gap:12px; }
    .day{
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
      background: rgba(255,255,255,.92);
    }
    .day-head{
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      margin-bottom:10px;
    }
    .day-head b{ font-size:14.5px; }
    .day-head span{ color:var(--muted); font-size:12.5px; }

    .meals{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:760px){ .meals{ grid-template-columns:1fr; } }

    .meal{
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:10px;
      background: rgba(255,255,255,.96);
    }
    .meal .kicker{
      display:flex; justify-content:space-between; align-items:flex-start; gap:8px;
    }
    .meal .kicker b{ font-size:13.5px; }
    .meal .meta{ color:var(--muted); font-size:12px; margin-top:3px; }

    .tags{ display:flex; flex-wrap:wrap; gap:6px; margin:8px 0 8px; }
    .tag{
      font-size:11.5px;
      padding:6px 9px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(31,184,106,.10);
      color:#173326;
      font-weight:700;
    }
    .tag.blue{ background: rgba(59,130,246,.10); color:#1a2c5b; }
    .tag.orange{ background: rgba(255,176,32,.14); color:#5a3a08; }
    .tag.red{ background: rgba(239,68,68,.10); color:#5a1a1a; }

    .how{ margin-top:6px; }
    .how b{ font-size:12.5px; }
    .how ul{ margin:6px 0 0 18px; padding:0; color:#2b3a33; }
    .how li{ margin:4px 0; font-size:12.5px; line-height:1.3; }

    .grocery{
      margin-top:12px;
      border:1px solid var(--stroke);
      border-radius:18px;
      background: rgba(255,255,255,.94);
      padding:12px;
    }
    .grocery-head{
      display:flex; justify-content:space-between; gap:10px; align-items:baseline;
      margin-bottom:10px;
    }
    .grocery-head b{ font-size:14px; }
    .grocery-head span{ color:var(--muted); font-size:12.5px; }

    .glist{ display:grid; gap:8px; }
    .gitem{
      border:1px dashed rgba(0,0,0,.12);
      border-radius:14px;
      padding:10px 10px;
      background: rgba(255,255,255,.9);
    }
    .gitem .name{ font-weight:900; font-size:13.5px; }
    .gitem .line{ margin-top:4px; color:var(--muted); font-size:12.5px; }
    .gitem .best{ margin-top:6px; font-size:12.5px; }
    .gitem .best b{ font-weight:900; }

    .footer{
      padding:14px 22px 18px;
      color:var(--muted);
      font-size:12.5px;
      border-top:1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.72);
    }

    /* --- PDF Template: keep renderable, off-screen (NOT display:none) --- */
    #pdf-template{
      position: fixed;
      left: -99999px;
      top: 0;
      width: 794px; /* ~A4 width at 96dpi */
      background: #fff;
      opacity: 0.01;
      pointer-events: none;
      z-index: -1;
    }

    /* PDF-only styling */
    .pdf{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:#0b1b14;
      padding: 22px;
    }
    .pdf .pdf-cover{
      border:1px solid rgba(0,0,0,.10);
      border-radius:18px;
      padding:18px;
      background: linear-gradient(180deg, rgba(31,184,106,.12), rgba(255,255,255,1));
    }
    .pdf .pdf-brand{
      display:flex; gap:12px; align-items:center;
      margin-bottom:10px;
    }
    .pdf .pdf-logo{
      width:44px; height:44px; border-radius:14px;
      background: radial-gradient(circle at 30% 30%, #77ffb8, #18a45d 55%, #0b7f44);
      display:flex; align-items:center; justify-content:center;
      color:white; font-weight:900;
    }
    .pdf h1{ margin:0; font-size:22px; }
    .pdf .pdf-sub{ margin:4px 0 0; color:#44554d; font-size:12.5px; }

    .pdf .pdf-grid{
      display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;
      margin-top:14px;
    }
    .pdf .pdf-box{
      border:1px solid rgba(0,0,0,.10);
      border-radius:14px;
      padding:10px;
      background:#fff;
    }
    .pdf .pdf-box b{ display:block; font-size:11.5px; color:#20352b; }
    .pdf .pdf-box span{ display:block; margin-top:4px; font-size:12.5px; color:#44554d; }

    .pdf .pdf-section{
      margin-top:14px;
      border:1px solid rgba(0,0,0,.10);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .pdf .pdf-section h2{
      margin:0 0 8px; font-size:14px;
    }
    .pdf .pdf-day{
      border:1px solid rgba(0,0,0,.10);
      border-radius:14px;
      padding:10px;
      margin-bottom:10px;
    }
    .pdf .pdf-dayhead{
      display:flex; justify-content:space-between; gap:10px; align-items:baseline;
      margin-bottom:8px;
      font-size:12.5px;
    }
    .pdf .pdf-table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    .pdf .pdf-table th{
      text-align:left;
      background: rgba(31,184,106,.10);
      border:1px solid rgba(0,0,0,.10);
      padding:8px;
      font-size:11.5px;
    }
    .pdf .pdf-table td{
      border:1px solid rgba(0,0,0,.10);
      padding:8px;
      vertical-align:top;
    }
    .pdf .pdf-muted{ color:#44554d; }
    .pdf .pdf-bullets{ margin:6px 0 0 16px; padding:0; }
    .pdf .pdf-bullets li{ margin:3px 0; }
    .pdf .pdf-hr{
      height:1px; background: rgba(0,0,0,.10); margin:12px 0;
    }
    .pdf .pagebreak{ page-break-before: always; }
    .pdf .small{ font-size:11.5px; }
    .pdf .right{ text-align:right; }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: rgba(10,15,12,.92);
      color:white;
      padding:10px 12px;
      border-radius:999px;
      font-size:12.5px;
      display:none;
      z-index:9999;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="shell">
      <div class="top">
        <div class="brand">
          <div class="logo">H</div>
          <div class="title">
            <h1>Healthy Meal Engine</h1>
            <p>Turn your grocery budget into a simple, healthy, realistic plan.</p>

            <div class="focus-chips">
              <div class="chip">
                <div class="dot"></div>
                <div>
                  <b>Primary: Busy Worker</b>
                  <span>Max results ‚Ä¢ minimal cooking ‚Ä¢ still healthy</span>
                </div>
              </div>
              <div class="chip">
                <div class="dot blue"></div>
                <div>
                  <b>Secondary: Budget-First</b>
                  <span>Stretch every dollar without eating trash</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="hero">
          <h2>Eat better on a real-person budget.</h2>
          <p>No calorie math, no diet culture ‚Äî just practical meals and a grocery list that match your time, money, and cravings.</p>

          <div class="bullets">
            <div class="pill"><i>ü•ó</i> 3 meals + snacks</div>
            <div class="pill"><i>üõí</i> Grocery list included</div>
            <div class="pill"><i>üí∏</i> Budget-aware picks</div>
          </div>

          <div class="photo-grid">
            <div class="photo big">
              <img alt="Food bowl" src="https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=80" crossorigin="anonymous">
            </div>
            <div class="photo-stack">
              <div class="photo">
                <img alt="Busy worker" src="https://images.unsplash.com/photo-1521737604893-d14cc237f11d?auto=format&fit=crop&w=900&q=80" crossorigin="anonymous">
              </div>
              <div class="photo">
                <img alt="Burger" src="https://images.unsplash.com/photo-1550547660-d9450f859349?auto=format&fit=crop&w=900&q=80" crossorigin="anonymous">
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>Build Your Week</h3>
        <div class="sub">Tell the engine how you actually live. We‚Äôll return meals and a grocery list that match your budget and energy.</div>

        <div class="card">
          <div class="step">
            <div class="num">1</div>
            <div>
              <b>Who are we feeding &amp; for how long?</b>
              <small>Focus mode: Quick &amp; easy vs ultra-cheap.</small>
            </div>
          </div>

          <div class="toggle" role="tablist" aria-label="Focus Mode">
            <button id="modeBusy" class="active" type="button">Busy Worker</button>
            <button id="modeBudget" type="button">Budget-First</button>
          </div>

          <div class="row">
            <div>
              <label for="budget">Total budget ($)</label>
              <input id="budget" inputmode="numeric" placeholder="100" value="100"/>
              <div class="hint">Try: <strong>Solo ‚Ä¢ 5 days ~ $75</strong> ‚Ä¢ <strong>Solo ‚Ä¢ 7 days ~ $100</strong> ‚Ä¢ <strong>2 people ‚Ä¢ 7 days ~ $150</strong></div>
            </div>
            <div>
              <label for="days"># days</label>
              <input id="days" inputmode="numeric" placeholder="7" value="7"/>
              <div class="hint">We‚Äôll generate a 7-day plan by default.</div>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <div>
              <label for="style">Eating style</label>
              <select id="style">
                <option value="omnivore">Omnivore (no major restrictions)</option>
                <option value="pesc">Pescatarian (fish OK)</option>
                <option value="veg">Vegetarian</option>
              </select>
            </div>
            <div>
              <label for="hardNo">Hard no ingredients</label>
              <input id="hardNo" placeholder='Comma-separated, e.g. "peanut butter, tuna, mushrooms"' />
              <div class="hint">We‚Äôll avoid these entirely.</div>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <div>
              <label for="constraints">Lifestyle constraints (optional)</label>
              <textarea id="constraints" placeholder='Short notes like "no oven", "office microwave only", "gym 3x nights".'></textarea>
              <div class="hint">Add context so the plan feels like your real life.</div>
            </div>
            <div>
              <label for="storePref">Store preference (optional)</label>
              <select id="storePref">
                <option value="any">No preference</option>
                <option value="discount">Discount grocer (Aldi/Lidl/Walmart)</option>
                <option value="bigbox">Big-box (Walmart/Target)</option>
                <option value="online">Online (Amazon)</option>
              </select>
              <div class="hint">We‚Äôll still show ‚ÄúBest at‚Äù store hints per ingredient.</div>
            </div>
          </div>

          <div class="actions">
            <button class="btn" id="genBtn" type="button">‚ú® Generate meal plan</button>

            <button class="btn secondary" id="pdfBtn" type="button" disabled>
              üìÑ <span id="pdfBtnLabel">Download plan as PDF</span>
            </button>

            <button class="btn secondary" id="copyBtn" type="button" disabled>üìã Copy grocery list</button>
          </div>

          <div class="notice">
            <b>Heads up:</b> Prices are rough estimates based on discount-grocer style pricing. Your store may vary.
            Re-run this anytime when your budget or schedule changes.
          </div>
        </div>

        <div id="output" class="out" style="display:none;">
          <h4>Your Weekly Plan</h4>

          <div class="summary">
            <div class="mini">
              <b>Total budget</b>
              <span id="sumBudget">$0</span>
            </div>
            <div class="mini">
              <b>Estimated food cost</b>
              <span id="sumCost">$0</span>
            </div>
            <div class="mini">
              <b>Buffer</b>
              <span id="sumBuffer">‚Äî</span>
            </div>
          </div>

          <div class="days" id="daysOut"></div>

          <div class="grocery">
            <div class="grocery-head">
              <b>Consolidated grocery list</b>
              <span><span id="uniqueCount">‚Äî</span> unique items</span>
            </div>
            <div class="glist" id="groceryOut"></div>
            <div class="actions" style="margin-top:10px;">
              <button class="btn secondary" type="button" id="copyBtn2">üìã Copy grocery list</button>
            </div>
          </div>

          <div class="hint" style="margin-top:10px;">
            Healthy Meal Engine ‚Ä¢ vNext ‚Äî polished PDF report output edition
          </div>
        </div>
      </div>

      <div class="footer">
        Built for real life, not Pinterest perfection.
      </div>
    </div>
  </div>

  <!-- Off-screen PDF template root (must exist, NOT display:none) -->
  <div id="pdf-template" aria-hidden="true"></div>

  <div id="toast" class="toast"></div>

  <!-- html2pdf (includes html2canvas + jsPDF). Keep as CDN for GitHub Pages. -->
  <script>
    // Robust loader so iPhone Safari doesn't race the PDF library.
    let pdfReady = false;

    function loadScript(src){
      return new Promise((resolve, reject)=>{
        const s=document.createElement('script');
        s.src=src;
        s.async=true;
        s.onload=()=>resolve();
        s.onerror=()=>reject(new Error("Failed to load: "+src));
        document.head.appendChild(s);
      });
    }

    (async function initPdfLib(){
      try{
        // Primary CDN
        await loadScript("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js");
        pdfReady = typeof html2pdf !== "undefined";
      }catch(e){
        // Fallback CDN
        try{
          await loadScript("https://unpkg.com/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js");
          pdfReady = typeof html2pdf !== "undefined";
        }catch(e2){
          pdfReady = false;
        }
      }
      document.getElementById("pdfBtn").disabled = !pdfReady;
      if(!pdfReady){
        document.getElementById("pdfBtnLabel").textContent = "PDF tools failed to load";
      }
    })();
  </script>

  <script>
    // ---------------------------
    // DATA (you can swap/extend later)
    // ---------------------------

    const groceryItems = [
      { name:"Milk or water", uses:0.3, budget:"$2‚Äì$4", best:"Any grocery / big-box" },
      { name:"Water", uses:0.5, budget:"$2‚Äì$4", best:"Any grocery store / big-box" },
      { name:"Flavor drops", uses:0.2, budget:"$3‚Äì$5", best:"Any grocery store / big-box" },
      { name:"Whole grain bread", uses:0.5, budget:"$2‚Äì$4", best:"Bakery or bread aisle (any grocery)" },
      { name:"Tortillas", uses:1.0, budget:"$2‚Äì$4", best:"Bread/tortilla aisle (any grocery)" },
      { name:"Chia seeds", uses:0.4, budget:"~$5", best:"Bulk aisle or online (Amazon)" },
      { name:"Canned tuna", uses:0.7, budget:"$3‚Äì$5", best:"Canned goods aisle (any grocery)" },
      { name:"Granola", uses:0.6, budget:"~$5", best:"Cereal aisle (big-box or grocery)" },
      { name:"Feta", uses:0.4, budget:"$3‚Äì$5", best:"Cheese section (any grocery)" },
      { name:"Oat or almond milk", uses:0.8, budget:"$3‚Äì$5", best:"Dairy alternative section (any grocery)" },
      { name:"Chicken thighs", uses:1.2, budget:"~$8", best:"Discount grocer (Aldi/Lidl/Walmart)" },
      { name:"Rolled oats", uses:0.8, budget:"$2‚Äì$4", best:"Discount grocer or bulk aisle" },
      { name:"Frozen salmon", uses:1.0, budget:"~$10", best:"Freezer / seafood section" },
      { name:"Frozen grain veggie bowl", uses:1.0, budget:"~$5", best:"Freezer aisle (big-box / grocery)" },
      { name:"Frozen berries", uses:0.9, budget:"$3‚Äì$5", best:"Freezer aisle (discount grocer or big-box)" },
      { name:"Frozen green beans", uses:0.8, budget:"$2‚Äì$4", best:"Frozen or produce section" },
      { name:"Rotisserie chicken", uses:0.8, budget:"~$8", best:"Grocery deli / hot foods" },
      { name:"Olive oil", uses:0.7, budget:"~$6", best:"Oils aisle (any grocery store / big-box)" },
      { name:"Protein powder", uses:0.3, budget:"~$18", best:"Online/big-box (Amazon, Walmart, Target)" },
      { name:"Peanut butter", uses:0.3, budget:"$2‚Äì$4", best:"Peanut butter/jam aisle" },
      { name:"Pickles or celery", uses:0.2, budget:"$2‚Äì$4", best:"Pickle aisle or produce" },
      { name:"Bananas", uses:1.0, budget:"$2‚Äì$4", best:"Produce section (any grocery)" },
      { name:"Cucumber", uses:0.6, budget:"$1‚Äì$2", best:"Produce section (any grocery)" },
      { name:"Carrots", uses:1.6, budget:"$2‚Äì$4", best:"Produce section (any grocery)" },
      { name:"Baby potatoes", uses:1.0, budget:"$2‚Äì$4", best:"Produce section (any grocery)" },
      { name:"Apples", uses:0.4, budget:"$2‚Äì$4", best:"Produce section (any grocery)" },
      { name:"Lemons", uses:0.4, budget:"$2‚Äì$4", best:"Produce section (any grocery)" },
      { name:"Baby carrots", uses:0.5, budget:"$1‚Äì$2", best:"Produce section (any grocery)" },
      { name:"Spinach", uses:0.3, budget:"$1‚Äì$2", best:"Produce section (any grocery)" },
      { name:"Greek yogurt", uses:0.8, budget:"~$5", best:"Refrigerated dairy (any grocery)" },
      { name:"Hummus", uses:1.0, budget:"$3‚Äì$5", best:"Refrigerated dips (any grocery)" },
      { name:"Rice", uses:0.8, budget:"$3‚Äì$5", best:"Rice/grains aisle (any grocery)" },
      { name:"Protein bars", uses:0.5, budget:"~$7", best:"Snacks or nutrition aisle (big-box/grocery)" },
      { name:"Seasoning blend", uses:0.2, budget:"$2‚Äì$4", best:"Spice aisle (any grocery)" },
      { name:"Green tea bags", uses:0.3, budget:"$2‚Äì$4", best:"Tea/coffee aisle" }
    ];

    // Estimated cost shown in your list
    const DEFAULT_EST_COST = 67.5;

    // Meal templates (minimal, busy-friendly; you can expand later)
    const mealTemplates = [
      {
        meal:"Breakfast",
        name:"Overnight oats with chia & banana",
        tags:["busy-friendly","budget pick","<10 min prep","high protein"],
        mins:5,
        cost:1.5,
        how:[
          "Add oats, chia seeds, and cinnamon to a jar or container.",
          "Pour in enough milk to fully cover the oats and stir.",
          "Refrigerate overnight; add sliced banana in the morning."
        ]
      },
      {
        meal:"Lunch",
        name:"Hummus, veggie & feta wrap",
        tags:["busy-friendly","<10 min prep"],
        mins:7,
        cost:2.5,
        how:[
          "Spread hummus over the tortilla.",
          "Add sliced cucumber, shredded carrots, and a sprinkle of feta.",
          "Roll up tightly and slice in half if desired."
        ]
      },
      {
        meal:"Dinner",
        name:"Sheet pan chicken, potatoes & carrots",
        tags:["budget pick","high protein"],
        mins:15,
        cost:3.0,
        how:[
          "Preheat oven to ~400¬∞F (200¬∞C) and line a sheet pan.",
          "Toss chicken, chopped potatoes, and carrots with olive oil + seasoning.",
          "Roast 25‚Äì35 minutes until cooked through and browned."
        ]
      },
      {
        meal:"Snack",
        name:"Apple + peanut butter",
        tags:["budget pick","<10 min prep"],
        mins:2,
        cost:1.0,
        how:[
          "Slice an apple just before eating.",
          "Serve with a spoonful or two of peanut butter for dipping."
        ]
      },
      {
        meal:"Beverage",
        name:"Green tea",
        tags:["budget pick","<10 min prep"],
        mins:3,
        cost:0.4,
        how:[
          "Boil water and let it sit 1‚Äì2 minutes to cool slightly.",
          "Steep tea bag 2‚Äì3 minutes.",
          "Remove bag to avoid bitterness."
        ]
      },
      {
        meal:"Beverage",
        name:"Water + flavor drops or lemon",
        tags:["budget pick","<10 min prep"],
        mins:1,
        cost:0.1,
        how:[
          "Fill a bottle or large cup with water.",
          "Squeeze in lemon or add a small amount of flavor drops.",
          "Sip throughout the day."
        ]
      }
    ];

    // ---------------------------
    // UI State
    // ---------------------------
    let mode = "busy"; // busy | budget
    let currentPlan = null;

    const $ = (id)=>document.getElementById(id);

    function setToast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(setToast._t);
      setToast._t = setTimeout(()=>{ t.style.display="none"; }, 1700);
    }

    function money(n){
      return "$" + (Math.round(n*10)/10).toFixed(1).replace(/\.0$/,'');
    }

    function parseNum(v, fallback){
      const n = Number(String(v).replace(/[^\d.]/g,""));
      return Number.isFinite(n) && n>0 ? n : fallback;
    }

    // ---------------------------
    // Toggle
    // ---------------------------
    $("modeBusy").addEventListener("click", ()=>{
      mode="busy";
      $("modeBusy").classList.add("active");
      $("modeBudget").classList.remove("active");
    });
    $("modeBudget").addEventListener("click", ()=>{
      mode="budget";
      $("modeBudget").classList.add("active");
      $("modeBusy").classList.remove("active");
    });

    // ---------------------------
    // Generate Plan
    // ---------------------------
    $("genBtn").addEventListener("click", ()=>{
      const budget = parseNum($("budget").value, 100);
      const days = Math.min(14, Math.max(1, Math.floor(parseNum($("days").value, 7))));
      const style = $("style").value;
      const hardNo = $("hardNo").value.trim();
      const constraints = $("constraints").value.trim();

      // For now: same meal pattern repeated (polished output) ‚Äî keeps it stable for a sellable PDF.
      // You can plug in your real engine later without changing the PDF system.
      const dayPlan = [];
      for(let d=1; d<=days; d++){
        const breakfast = mealTemplates[0];
        const lunch = mealTemplates[1];
        const dinner = (d%3===0) ? { ...mealTemplates[2], name:"Baked salmon, rice & green beans", cost:4.2, mins:12,
          how:[
            "Preheat oven to ~400¬∞F (200¬∞C). Place salmon on a lined tray; drizzle with olive oil, salt, pepper, lemon.",
            "Bake salmon 12‚Äì18 minutes depending on thickness.",
            "Cook rice and steam/microwave green beans; serve together."
          ],
          tags:["high protein"]
        } : mealTemplates[2];

        const snack = (d%2===0) ? { ...mealTemplates[3], name:"Carrots & hummus", cost:0.9, mins:2,
          how:[
            "Portion baby carrots into a container.",
            "Add a scoop of hummus for dipping."
          ],
          tags:["busy-friendly","budget pick","<10 min prep"]
        } : mealTemplates[3];

        const beverage = (d%2===0) ? mealTemplates[4] : mealTemplates[5];

        const estDaily = breakfast.cost + lunch.cost + dinner.cost + snack.cost + beverage.cost;

        dayPlan.push({
          day: d,
          estDaily,
          items: [breakfast, lunch, dinner, snack, beverage]
        });
      }

      // Cost model: use your consolidated grocery estimate as the driver (sellable + predictable)
      // You can swap this to computed totals later.
      const estFoodCost = DEFAULT_EST_COST;
      const buffer = budget - estFoodCost;

      currentPlan = {
        budget,
        days,
        style,
        hardNo,
        constraints,
        mode,
        estFoodCost,
        buffer,
        dayPlan,
        groceryItems
      };

      renderPlan();
    });

    function tagChip(t){
      const lower = t.toLowerCase();
      if(lower.includes("busy")) return `<span class="tag blue">busy-friendly</span>`;
      if(lower.includes("budget")) return `<span class="tag">budget pick</span>`;
      if(lower.includes("protein")) return `<span class="tag orange">high protein</span>`;
      if(lower.includes("<10")) return `<span class="tag red">&lt;10 min prep</span>`;
      if(lower.includes("quick")) return `<span class="tag red">quick</span>`;
      return `<span class="tag">${escapeHtml(t)}</span>`;
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;");
    }

    function renderPlan(){
      $("output").style.display = "block";
      $("copyBtn").disabled = false;
      $("copyBtn2").disabled = false;
      $("pdfBtn").disabled = !pdfReady;

      $("sumBudget").textContent = money(currentPlan.budget);
      $("sumCost").textContent = money(currentPlan.estFoodCost);

      if(currentPlan.buffer >= 0){
        $("sumBuffer").textContent = `~${money(currentPlan.buffer)} under budget (buffer for tax / price swings)`;
      }else{
        $("sumBuffer").textContent = `~${money(Math.abs(currentPlan.buffer))} over budget ‚Äî consider trimming snacks or portions`;
      }

      // Days
      const daysOut = $("daysOut");
      daysOut.innerHTML = "";

      for(const d of currentPlan.dayPlan){
        const dayDiv = document.createElement("div");
        dayDiv.className = "day";

        dayDiv.innerHTML = `
          <div class="day-head">
            <b>Day ${d.day}</b>
            <span>Est. daily cost: ${money(d.estDaily)}</span>
          </div>

          <div class="meals">
            ${d.items.map(m => `
              <div class="meal">
                <div class="kicker">
                  <b>${escapeHtml(m.meal)}</b>
                  <span class="meta">${m.mins} min ‚Ä¢ ~${money(m.cost)}/serv</span>
                </div>
                <div class="meta"><b>${escapeHtml(m.name)}</b></div>
                <div class="tags">${m.tags.map(tagChip).join("")}</div>
                <div class="how">
                  <b>How to make:</b>
                  <ul>${m.how.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>
                </div>
              </div>
            `).join("")}
          </div>
        `;
        daysOut.appendChild(dayDiv);
      }

      // Grocery list
      $("uniqueCount").textContent = String(currentPlan.groceryItems.length);
      const gl = $("groceryOut");
      gl.innerHTML = "";
      currentPlan.groceryItems.forEach(item=>{
        const el=document.createElement("div");
        el.className="gitem";
        el.innerHTML = `
          <div class="name">${escapeHtml(item.name)}</div>
          <div class="line">~${item.uses} uses this week, budget: <b>${escapeHtml(item.budget)}</b></div>
          <div class="best"><b>Best at:</b> ${escapeHtml(item.best)}</div>
        `;
        gl.appendChild(el);
      });

      setToast("Plan generated.");
    }

    // Copy list (same for both buttons)
    function groceryText(){
      const lines = [];
      lines.push("Grocery list from Healthy Meal Engine");
      lines.push("");
      currentPlan.groceryItems.forEach(i=>{
        lines.push(`- ${i.name} ‚Äî ~${i.uses} uses this week, budget: ${i.budget} ‚Ä¢ ${i.best}`);
      });
      lines.push("");
      lines.push(`Estimated food cost: ${money(currentPlan.estFoodCost)} (before tax).`);
      return lines.join("\n");
    }

    async function copyGrocery(){
      if(!currentPlan) return;
      try{
        await navigator.clipboard.writeText(groceryText());
        setToast("Copied grocery list.");
      }catch(e){
        // Fallback
        const ta = document.createElement("textarea");
        ta.value = groceryText();
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        setToast("Copied grocery list.");
      }
    }

    $("copyBtn").addEventListener("click", copyGrocery);
    $("copyBtn2").addEventListener("click", copyGrocery);

    // ---------------------------
    // PDF (polished, multi-page)
    // ---------------------------
    $("pdfBtn").addEventListener("click", generatePdf);

    function buildPdfHtml(){
      const focusLabel = currentPlan.mode === "busy" ? "Busy Worker" : "Budget-First";

      const cover = `
        <div class="pdf">
          <div class="pdf-cover">
            <div class="pdf-brand">
              <div class="pdf-logo">H</div>
              <div>
                <h1>Healthy Meal Engine ‚Ä¢ Weekly Meal Plan</h1>
                <div class="pdf-sub">A clean, execution-ready plan + consolidated grocery list.</div>
              </div>
            </div>

            <div class="pdf-grid">
              <div class="pdf-box"><b>Total budget</b><span>${money(currentPlan.budget)}</span></div>
              <div class="pdf-box"><b>Estimated food cost</b><span>${money(currentPlan.estFoodCost)} (before tax)</span></div>
              <div class="pdf-box"><b>Focus</b><span>${focusLabel}</span></div>
            </div>

            <div class="pdf-section" style="margin-top:12px;">
              <h2>Plan notes</h2>
              <div class="small pdf-muted">
                <div><b>Eating style:</b> ${escapeHtml(currentPlan.style)}</div>
                <div><b>Hard no ingredients:</b> ${escapeHtml(currentPlan.hardNo || "‚Äî")}</div>
                <div><b>Lifestyle constraints:</b> ${escapeHtml(currentPlan.constraints || "‚Äî")}</div>
              </div>
              <div class="pdf-hr"></div>
              <div class="small pdf-muted">
                Prices are rough estimates based on discount-grocer style pricing. Your store may vary.
                Re-run anytime when your budget or schedule changes.
              </div>
            </div>
          </div>

          <div class="pagebreak"></div>

          <div class="pdf-section">
            <h2>Daily meal plan</h2>
            ${currentPlan.dayPlan.map(d => `
              <div class="pdf-day">
                <div class="pdf-dayhead">
                  <b>Day ${d.day}</b>
                  <span class="pdf-muted">Est. daily cost: ${money(d.estDaily)}</span>
                </div>
                <table class="pdf-table">
                  <thead>
                    <tr>
                      <th style="width:16%;">Meal</th>
                      <th style="width:34%;">What it is</th>
                      <th style="width:15%;">Time / cost</th>
                      <th>How to make</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${d.items.map(m => `
                      <tr>
                        <td><b>${escapeHtml(m.meal)}</b></td>
                        <td>
                          <div><b>${escapeHtml(m.name)}</b></div>
                          <div class="small pdf-muted">${m.tags.map(t=>escapeHtml(t)).join(" ‚Ä¢ ")}</div>
                        </td>
                        <td class="small">
                          <div>${m.mins} min</div>
                          <div class="pdf-muted">~${money(m.cost)}/serv</div>
                        </td>
                        <td class="small">
                          <ul class="pdf-bullets">${m.how.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>
                        </td>
                      </tr>
                    `).join("")}
                  </tbody>
                </table>
              </div>
              ${(d.day % 2 === 0) ? `<div class="pagebreak"></div>` : ``}
            `).join("")}
          </div>

          <div class="pagebreak"></div>

          <div class="pdf-section">
            <h2>Consolidated grocery list</h2>
            <div class="small pdf-muted" style="margin-bottom:10px;">
              ${currentPlan.groceryItems.length} unique items ‚Ä¢ Estimated food cost: ${money(currentPlan.estFoodCost)} (before tax)
            </div>
            <table class="pdf-table">
              <thead>
                <tr>
                  <th style="width:28%;">Item</th>
                  <th style="width:18%;">Uses this week</th>
                  <th style="width:18%;">Budget</th>
                  <th>Best at</th>
                </tr>
              </thead>
              <tbody>
                ${currentPlan.groceryItems.map(i => `
                  <tr>
                    <td><b>${escapeHtml(i.name)}</b></td>
                    <td class="small">${escapeHtml("~" + i.uses)}</td>
                    <td class="small">${escapeHtml(i.budget)}</td>
                    <td class="small">${escapeHtml(i.best)}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>

            <div class="pdf-hr"></div>
            <div class="small pdf-muted">
              Generated by Healthy Meal Engine ‚Ä¢ ‚ÄúBuilt for real life, not Pinterest perfection.‚Äù
            </div>
          </div>
        </div>
      `;

      return cover;
    }

    async function generatePdf(){
      if(!pdfReady || typeof html2pdf === "undefined"){
        alert("PDF tools didn‚Äôt load correctly. Please refresh and try again.");
        return;
      }
      if(!currentPlan){
        alert("Generate a meal plan first.");
        return;
      }

      const pdfBtn = $("pdfBtn");
      const label = $("pdfBtnLabel");

      pdfBtn.disabled = true;
      label.textContent = "Preparing PDF‚Ä¶";

      const pdfRoot = $("pdf-template");

      // IMPORTANT: must not be display:none (we keep it off-screen via CSS)
      pdfRoot.innerHTML = buildPdfHtml();

      // give layout/fonts a moment (iPhone Safari needs it)
      await new Promise(r => setTimeout(r, 450));

      // Wait for any images inside (currently none in PDF, but safe for future)
      const imgs = Array.from(pdfRoot.querySelectorAll("img"));
      await Promise.all(imgs.map(img => img.complete ? Promise.resolve() : new Promise(res => { img.onload=res; img.onerror=res; })));

      const filename = `Healthy-Meal-Plan.pdf`;

      const opt = {
        margin:       [10, 10, 10, 10], // mm-ish via html2pdf wrapper
        filename,
        image:        { type: "jpeg", quality: 0.95 },
        html2canvas:  { scale: 2, useCORS: true, allowTaint: true, backgroundColor: "#ffffff" },
        jsPDF:        { unit: "mm", format: "a4", orientation: "portrait" },
        pagebreak:    { mode: ["css", "legacy"] }
      };

      try{
        await html2pdf().set(opt).from(pdfRoot).save();
        setToast("PDF downloaded.");
      }catch(e){
        console.error(e);
        alert("PDF generation failed. Try again in 1‚Äì2 seconds.");
      }finally{
        pdfBtn.disabled = false;
        label.textContent = "Download plan as PDF";
      }
    }
  </script>
</body>
</html>
